<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LitWire Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="bg-white shadow-md py-4 sticky top-0 z-50">
        <nav class="container flex justify-between items-center px-4 md:px-8">
            <div class="text-3xl font-bold text-gray-800">
                <span class="text-purple-600">Lit</span><span class="text-gray-900">Wire</span>
            </div>
            <div class="flex items-center space-x-6">
                <button id="nav-feed" class="text-gray-600 hover:text-purple-600 font-medium transition duration-300">Feed</button>
                <button id="nav-authors" class="text-gray-600 hover:text-purple-600 font-medium transition duration-300">Authors</button>
                <button id="nav-influencers" class="text-gray-600 hover:text-purple-600 font-medium transition duration-300">Influencers</button>
                <button id="nav-profile" class="text-gray-600 hover:text-purple-600 font-medium transition duration-300">Profile</button>
                <button id="nav-matches" class="text-gray-600 hover:text-purple-600 font-medium transition duration-300">Matches</button>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mt-12 px-4 md:px-8">
        <!-- Loading state -->
        <div id="loading" class="text-center py-10">
            <div class="spinner-border animate-spin inline-block w-12 h-12 border-4 rounded-full border-purple-600 border-r-transparent" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="text-gray-600 mt-4">Connecting to the LitWire network...</p>
        </div>

        <!-- Main Content View -->
        <div id="content" class="space-y-12 hidden">
            <!-- User Info Bar -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-purple-600 text-center">
                <p class="text-sm text-gray-500">Logged in as: <span id="user-id" class="font-mono text-xs text-purple-600"></span></p>
                <p class="text-sm text-gray-500 mt-1">Account Type: <span id="user-type" class="font-semibold text-gray-700">Not Set</span></p>
            </div>

            <!-- Feed View -->
            <section id="feed-view" class="view">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Social Feed</h2>
                <div id="posts-container" class="space-y-8">
                    <!-- Posts will be rendered here -->
                </div>
            </section>

            <!-- Profile View -->
            <section id="profile-view" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">My Profile</h2>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-purple-600">
                    <p class="text-lg font-semibold mb-6">Choose your account type:</p>
                    <div class="flex space-x-4 mb-8">
                        <button id="author-btn" class="flex-1 px-8 py-3 rounded-xl font-semibold transition duration-300 bg-purple-600 text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">I'm an Author</button>
                        <button id="influencer-btn" class="flex-1 px-8 py-3 rounded-xl font-semibold transition duration-300 bg-sky-500 text-white hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">I'm an Influencer</button>
                    </div>

                    <!-- Author Profile Form -->
                    <div id="author-form-container" class="hidden">
                        <h3 class="text-2xl font-bold mb-6 text-purple-600">Author Profile Setup</h3>
                        <form id="author-form" class="space-y-6">
                            <div>
                                <label for="author-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                                <input type="text" id="author-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-3">
                            </div>
                            <div>
                                <label for="author-bio" class="block text-sm font-medium text-gray-700">Bio</label>
                                <textarea id="author-bio" rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-3"></textarea>
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">Save Profile</button>
                        </form>
                    </div>

                    <!-- Influencer Profile Form -->
                    <div id="influencer-form-container" class="hidden">
                        <h3 class="text-2xl font-bold mb-6 text-sky-500">Influencer Profile Setup</h3>
                        <form id="influencer-form" class="space-y-6">
                            <div>
                                <label for="influencer-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                                <input type="text" id="influencer-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 p-3">
                            </div>
                            <div>
                                <label for="influencer-platform" class="block text-sm font-medium text-gray-700">Main Platform (e.g., TikTok, Instagram, Blog)</label>
                                <input type="text" id="influencer-platform" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 p-3">
                            </div>
                            <div>
                                <label for="influencer-interests" class="block text-sm font-medium text-gray-700">Niche Interests (e.g., historical romance, dark academia)</label>
                                <input type="text" id="influencer-interests" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 p-3">
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-sky-500 text-white rounded-lg shadow-md hover:bg-sky-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">Save Profile</button>
                        </form>
                    </div>

                    <!-- Book Ingestion Form (for authors) -->
                    <div id="book-form-container" class="hidden mt-12">
                        <h3 class="text-2xl font-bold mb-6 text-purple-600">Ingress a New Book</h3>
                        <form id="book-form" class="space-y-6">
                            <div>
                                <label for="book-title" class="block text-sm font-medium text-gray-700">Book Title</label>
                                <input type="text" id="book-title" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div>
                                <label for="book-blurb" class="block text-sm font-medium text-gray-700">Blurb</label>
                                <textarea id="book-blurb" rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"></textarea>
                            </div>
                            <div>
                                <label for="book-cover" class="block text-sm font-medium text-gray-700">Cover Image URL</label>
                                <input type="text" id="book-cover" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">Submit Book</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Authors View -->
            <section id="authors-view" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Authors</h2>
                <div id="authors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Author cards will be rendered here -->
                </div>
            </section>

            <!-- Influencers View -->
            <section id="influencers-view" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Influencers</h2>
                <div id="influencers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Influencer cards will be rendered here -->
                </div>
            </section>

            <!-- Matches View -->
            <section id="matches-view" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Matches</h2>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-purple-600">
                    <p class="text-gray-600 text-center text-lg">
                        This is where we'd use our matchmaking algorithm! For the MVP, here's a random selection of potential matches.
                    </p>
                    <div id="matches-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
                        <!-- Match cards will be rendered here -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container text-center text-sm">
            &copy; 2024 LitWire. All rights reserved.
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        let db, auth, userId;
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // This is the main entry point for the app. It will run every time the auth state changes.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                document.getElementById('user-id').textContent = userId;
                console.log("Authenticated with user ID:", userId);
                
                // Now that we have a user, we can initialize the app.
                initApp();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            } else {
                // User is signed out. Attempt to sign in again.
                console.log("No user found. Signing in.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    document.getElementById('loading').textContent = "Failed to connect. Please try again.";
                }
            }
        });
        
        // --- Data Models and Dummy Data ---
        const dummyPosts = [
            { id: uuid.v4(), author: "Samantha", content: "Just finished my latest manuscript! It's a dark romance with a touch of fantasy. I'm so excited to find the perfect influencers to review it.", type: "author", timestamp: Date.now() - 3600000 },
            { id: uuid.v4(), author: "Bookworm Emily", content: "Looking for new authors to collaborate with! My channel focuses on spicy historical romance. Drop your books below!", type: "influencer", timestamp: Date.now() - 7200000 },
            { id: uuid.v4(), author: "Liam Jones", content: "Thinking about a new campaign for my book 'Crimson Vows'. Maybe a giveaway for a signed copy and a cozy bookmark.", type: "author", timestamp: Date.now() - 10800000 },
            { id: uuid.v4(), author: "Reading Sarah", content: "My latest TikTok review of 'Midnight Whispers' is live! The author's world-building is incredible.", type: "influencer", timestamp: Date.now() - 14400000 },
            { id: uuid.v4(), author: "Chloe's Novels", content: "My new book cover reveal is coming soon! Any influencers interested in a sneak peek?", type: "author", timestamp: Date.now() - 18000000 },
        ];

        const dummyAuthors = [
            { id: 'dummy-author-1', name: 'Samantha', bio: 'Romance author specializing in fantasy and paranormal. Known for strong female leads and intricate world-building.' },
            { id: 'dummy-author-2', name: 'Liam Jones', bio: 'New York Times bestselling author of contemporary romance novels with a hint of suspense. I love writing about second chances.' },
            { id: 'dummy-author-3', name: 'Chloe\'s Novels', bio: 'I write steamy, feel-good romance novels set in small towns. Currently working on a new series!' }
        ];

        const dummyInfluencers = [
            { id: 'dummy-influencer-1', name: 'Bookworm Emily', platform: 'TikTok, Instagram', interests: 'Historical Romance, Spicy Romcoms' },
            { id: 'dummy-influencer-2', name: 'Reading Sarah', platform: 'Blog, YouTube', interests: 'Dark Academia, Fantasy Romance' },
            { id: 'dummy-influencer-3', name: 'The Book Nook', platform: 'YouTube', interests: 'Contemporary Romance, Paranormal Romance' }
        ];

        let userType = null;

        // --- UI Rendering Functions ---
        function renderView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function renderPosts(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';
            posts.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white p-6 rounded-2xl shadow-lg border-t-4 border-gray-200';
                postElement.innerHTML = `
                    <div class="flex items-center space-x-4 mb-2">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl ${post.type === 'author' ? 'bg-purple-200 text-purple-700' : 'bg-sky-200 text-sky-700'}">${post.author.charAt(0)}</div>
                        <div>
                            <p class="font-semibold text-gray-800 text-lg">${post.author}</p>
                            <p class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 mt-4 leading-relaxed">${post.content}</p>
                `;
                container.appendChild(postElement);
            });
        }

        function renderAuthors(authors) {
            const container = document.getElementById('authors-container');
            container.innerHTML = '';
            authors.forEach(author => {
                const card = document.createElement('div');
                card.className = 'bg-white p-8 rounded-2xl shadow-lg border-t-4 border-purple-600';
                const booksHtml = author.books ? author.books.map(book => `
                    <div class="p-2 bg-gray-100 rounded-lg text-xs font-semibold text-gray-600">${book.title}</div>
                `).join('') : '';

                card.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-16 h-16 bg-purple-200 rounded-full flex items-center justify-center font-bold text-purple-700 text-2xl">${author.name.charAt(0)}</div>
                        <h3 class="font-bold text-2xl text-gray-800">${author.name}</h3>
                    </div>
                    <p class="text-gray-600 text-sm leading-snug">${author.bio}</p>
                    <div class="mt-6 flex flex-wrap gap-2">
                        ${booksHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderInfluencers(influencers) {
            const container = document.getElementById('influencers-container');
            container.innerHTML = '';
            influencers.forEach(influencer => {
                const card = document.createElement('div');
                card.className = 'bg-white p-8 rounded-2xl shadow-lg border-t-4 border-sky-500';
                card.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-16 h-16 bg-sky-200 rounded-full flex items-center justify-center font-bold text-sky-700 text-2xl">${influencer.name.charAt(0)}</div>
                        <h3 class="font-bold text-2xl text-gray-800">${influencer.name}</h3>
                    </div>
                    <p class="text-gray-600 text-sm">Platform: <span class="font-semibold text-gray-800">${influencer.platform}</span></p>
                    <p class="text-gray-600 text-sm mt-1">Interests: <span class="font-semibold text-gray-800">${influencer.interests}</span></p>
                `;
                container.appendChild(card);
            });
        }

        function renderMatches(matches) {
            const container = document.getElementById('matches-container');
            container.innerHTML = '';
            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-2xl shadow-md border border-gray-200';
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${match.name}</h3>
                    <p class="text-gray-600 text-sm mt-1">${match.type === 'author' ? 'Author' : 'Influencer'}</p>
                    <p class="text-gray-500 text-xs mt-2 truncate">${match.bio || match.interests}</p>
                    <button class="mt-4 px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition duration-300">Connect</button>
                `;
                container.appendChild(card);
            });
        }

        // --- Data Fetching and Event Listeners ---
        function initApp() {
            // Check for existing user profile
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
            getDoc(userDocRef).then(docSnap => {
                if (docSnap.exists()) {
                    userType = docSnap.data().type;
                    document.getElementById('user-type').textContent = userType.charAt(0).toUpperCase() + userType.slice(1);
                    if (userType === 'author') {
                        document.getElementById('book-form-container').classList.remove('hidden');
                        document.getElementById('author-form-container').classList.remove('hidden');
                    } else if (userType === 'influencer') {
                        document.getElementById('influencer-form-container').classList.remove('hidden');
                    }
                }
            }).catch(e => console.error("Error fetching user profile:", e));

            // Set up real-time listeners for all data
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), (snapshot) => {
                const posts = snapshot.docs.map(doc => doc.data());
                renderPosts(posts.concat(dummyPosts));
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), async (snapshot) => {
                const users = snapshot.docs.map(doc => doc.data());
                
                // Fetch books for each author
                const authorPromises = users.filter(u => u.type === 'author').map(async (author) => {
                    const booksQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'books'), where('authorId', '==', author.userId));
                    const bookSnapshot = await getDocs(booksQuery);
                    const books = bookSnapshot.docs.map(doc => doc.data());
                    return { ...author, books };
                });
                
                const fetchedAuthors = await Promise.all(authorPromises);
                const authors = fetchedAuthors.concat(dummyAuthors);
                const influencers = users.filter(u => u.type === 'influencer').concat(dummyInfluencers);

                renderAuthors(authors);
                renderInfluencers(influencers);
            });

            // Set up event listeners for navigation
            document.getElementById('nav-feed').addEventListener('click', () => renderView('feed-view'));
            document.getElementById('nav-profile').addEventListener('click', () => renderView('profile-view'));
            document.getElementById('nav-authors').addEventListener('click', () => renderView('authors-view'));
            document.getElementById('nav-influencers').addEventListener('click', () => renderView('influencers-view'));
            document.getElementById('nav-matches').addEventListener('click', () => {
                const allUsers = [...dummyAuthors, ...dummyInfluencers];
                const matches = allUsers.sort(() => 0.5 - Math.random()).slice(0, 6);
                renderMatches(matches);
                renderView('matches-view');
            });
            
            // Initial view
            renderView('feed-view');
        }

        // --- Forms and Data Submission ---
        document.getElementById('author-btn').addEventListener('click', () => {
            document.getElementById('author-form-container').classList.remove('hidden');
            document.getElementById('influencer-form-container').classList.add('hidden');
        });

        document.getElementById('influencer-btn').addEventListener('click', () => {
            document.getElementById('influencer-form-container').classList.remove('hidden');
            document.getElementById('author-form-container').classList.add('hidden');
        });

        document.getElementById('author-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('author-name').value;
            const bio = document.getElementById('author-bio').value;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), {
                    userId,
                    type: 'author',
                    name,
                    bio,
                });
                userType = 'author';
                document.getElementById('user-type').textContent = 'Author';
                document.getElementById('book-form-container').classList.remove('hidden');
                console.log("Author profile saved successfully!");
            } catch (e) {
                console.error("Error saving author profile: ", e);
            }
        });

        document.getElementById('influencer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('influencer-name').value;
            const platform = document.getElementById('influencer-platform').value;
            const interests = document.getElementById('influencer-interests').value;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), {
                    userId,
                    type: 'influencer',
                    name,
                    platform,
                    interests,
                });
                userType = 'influencer';
                document.getElementById('user-type').textContent = 'Influencer';
                console.log("Influencer profile saved successfully!");
            } catch (e) {
                console.error("Error saving influencer profile: ", e);
            }
        });

        document.getElementById('book-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('book-title').value;
            const blurb = document.getElementById('book-blurb').value;
            const cover = document.getElementById('book-cover').value;
            const userName = document.getElementById('author-name').value;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'books'), {
                    authorId: userId,
                    authorName: userName,
                    title,
                    blurb,
                    cover,
                });
                // Create a dummy post for the feed
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                    author: userName,
                    content: `My new book '${title}' is out now! Check it out!`,
                    type: "author",
                    timestamp: Date.now(),
                });
                e.target.reset();
                console.log("Book and post submitted successfully!");
            } catch (e) {
                console.error("Error submitting book: ", e);
            }
        });
    </script>
</body>
</html>
