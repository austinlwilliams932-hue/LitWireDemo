<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration and State Variables ---
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'demo-app';
        let firebaseConfig = null;
        let demoMode = false;

        try {
            if (typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
                firebaseConfig = JSON.parse(window.__firebase_config);
            }
        } catch (e) {
            console.error("Failed to parse Firebase configuration:", e);
        }

        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let userProfile = null;
        let currentRecipientId = null;
        let currentChatId = null;

        let demoUsers = [];
        let demoPosts = [];
        let demoMessages = [];

        // --- DOM Element References ---
        const loadingEl = document.getElementById('loading');
        const configMissingEl = document.getElementById('config-missing');
        const onboardingView = document.getElementById('onboarding-view');
        const contentEl = document.getElementById('content');
        const userIdEl = document.getElementById('user-id');
        const userTypeEl = document.getElementById('user-type');
        const demoIndicator = document.getElementById('demo-indicator');

        const collections = {
            users: `users`,
            posts: `posts`,
            messages: `messages`,
        };

        // --- Core Application Logic ---

        /**
         * Displays an error message on the loading screen and hides the spinner.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            console.error("LitWire Error:", message);
            const loadingMessage = document.getElementById('loading-message');
            const spinner = document.querySelector('#loading .spinner-border');
            
            if (spinner) spinner.style.display = 'none'; // Hide the spinner icon
            
            loadingMessage.textContent = `Error: ${message}`;
            loadingMessage.className = 'text-red-600 font-semibold mt-4';
        }

        /**
         * Hides loading/onboarding and displays the main content sections.
         */
        function showMainContent() {
            loadingEl.classList.add('hidden');
            onboardingView.classList.add('hidden');
            configMissingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
        }

        /**
         * Main entry point for initializing the application.
         */
        async function initializeAppAndAuth() {
            // Set a timeout as a fallback for network or config issues.
            const startupTimeout = setTimeout(() => {
                showError("Connection timed out. Please check your internet connection and try again.");
            }, 15000); // 15-second timeout

            // 1. Check for valid Firebase Configuration
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('your-api-key')) {
                clearTimeout(startupTimeout);
                loadingEl.classList.add('hidden');
                configMissingEl.classList.remove('hidden');
                return; // Stop initialization
            }

            try {
                // 2. Initialize Firebase services
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 3. Set up the authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        clearTimeout(startupTimeout); // Successful auth, clear timeout
                        userId = user.uid;
                        userIdEl.textContent = userId;

                        try {
                            // 4. Fetch the user's profile from Firestore
                            const userDoc = await getDoc(doc(db, collections.users, userId));
                            if (userDoc.exists()) {
                                userProfile = userDoc.data();
                                userTypeEl.textContent = userProfile.type || 'Not Set';
                                if (userProfile.type === 'author') {
                                    document.getElementById('book-form-container').classList.remove('hidden');
                                }
                                showMainContent();
                                loadInitialData(); // Load feed, authors, etc.
                            } else {
                                // This is a new user, show the onboarding screen
                                loadingEl.classList.add('hidden');
                                onboardingView.classList.remove('hidden');
                            }
                        } catch (dbError) {
                            showError(`Failed to load user profile. ${dbError.message}`);
                        }
                    }
                    // If user is null, the sign-in attempt below will trigger this listener again.
                });

                // 5. Attempt to sign in if no user is currently active
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            } catch (error) {
                clearTimeout(startupTimeout);
                showError(`Initialization failed. ${error.message}`);
            }
        }
        
        /**
         * Fetches and renders the initial data like posts and user lists.
         */
        async function loadInitialData() {
            try {
                // Fetch all users to display in Authors/Influencers lists
                const usersSnapshot = await getDocs(query(collection(db, collections.users)));
                const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderAuthors(allUsers.filter(u => u.type === 'author'));
                renderInfluencers(allUsers.filter(u => u.type === 'influencer'));
                renderMatches(allUsers.filter(u => u.id !== userId)); // Simple match logic

                // Fetch posts for the feed
                const postsSnapshot = await getDocs(query(collection(db, collections.posts)));
                const posts = postsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts(posts);

            } catch (error) {
                console.error("Error loading initial data:", error);
                document.getElementById('posts-container').innerHTML = `<p class="text-red-500 text-center">Could not load feed. ${error.message}</p>`;
            }
        }


        // --- Event Listeners ---

        // Onboarding form submissions with error handling
        document.getElementById('author-form').addEventListener('submit', handleProfileSave);
        document.getElementById('influencer-form').addEventListener('submit', handleProfileSave);

        async function handleProfileSave(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const isAuthor = form.id === 'author-form';
            
            let profileData;
            if (isAuthor) {
                profileData = {
                    name: document.getElementById('author-name').value,
                    bio: document.getElementById('author-bio').value,
                    type: 'author',
                    id: userId
                };
            } else {
                profileData = {
                    name: document.getElementById('influencer-name').value,
                    platform: document.getElementById('influencer-platform').value,
                    interests: document.getElementById('influencer-interests').value,
                    type: 'influencer',
                    id: userId
                };
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                if (demoMode) {
                    saveDemoUser(profileData);
                } else {
                    await setDoc(doc(db, collections.users, userId), profileData);
                }
                userProfile = profileData;
                userTypeEl.textContent = profileData.type;
                showMainContent();
                if (isAuthor) {
                    document.getElementById('book-form-container').classList.remove('hidden');
                }
                loadInitialData(); // Reload data to show new profile
            } catch (error) {
                alert(`Error saving profile: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Profile';
            }
        }
        
        // Navigation logic
        document.querySelector('nav').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const viewId = e.target.id.replace('nav-', '') + '-view';
                if(document.getElementById(viewId)) {
                    renderView(viewId);
                }
                if (e.target.id === 'nav-logout') {
                    signOut(auth).catch(err => alert(err.message));
                    window.location.reload();
                }
            }
        });
        
        // Onboarding buttons
        document.getElementById('author-btn').addEventListener('click', () => {
            document.getElementById('author-form-container').classList.remove('hidden');
            document.getElementById('influencer-form-container').classList.add('hidden');
        });

        document.getElementById('influencer-btn').addEventListener('click', () => {
            document.getElementById('influencer-form-container').classList.remove('hidden');
            document.getElementById('author-form-container').classList.add('hidden');
        });
        
        // Demo mode button
        document.getElementById('demo-mode-btn').addEventListener('click', () => {
             initDemoMode();
             showMainContent();
        });


        // --- Demo Mode Functions ---
        function initDemoMode() {
            demoMode = true;
            userId = 'demo-user-' + Math.random().toString(36).substr(2, 9);
            userIdEl.textContent = userId;
            demoIndicator.classList.remove('hidden');
            
            demoPosts = [
                { content: "Exploring dark academia themes in my new thriller. It's going to be epic!", name: "Veronica Roth", type: "author", timestamp: Date.now() - 3600000 },
                { content: "Who are the best authors to follow for fantasy world-building tips? Asking for my next YouTube video!", name: "BookishBrian", type: "influencer", timestamp: Date.now() - 7200000 }
            ];
            demoUsers = [
                { id: 'author-1', name: 'Veronica Roth', type: 'author', bio: 'NYT Bestselling author of thrillers.', books: [{ title: 'The Silent Key', blurb: 'A story of espionage.' }] },
                { id: 'influencer-1', name: 'BookishBrian', type: 'influencer', platform: 'YouTube', interests: 'Fantasy, Sci-fi' }
            ];

            renderPosts(demoPosts);
            renderAuthors(demoUsers.filter(u => u.type === 'author'));
            renderInfluencers(demoUsers.filter(u => u.type === 'influencer'));
            renderMatches(demoUsers);
        }

        function saveDemoUser(user) {
            userProfile = user;
            demoUsers.push(user);
            renderAuthors(demoUsers.filter(u => u.type === 'author'));
            renderInfluencers(demoUsers.filter(u => u.type === 'influencer'));
        }

        // --- UI Rendering Functions (Unchanged) ---
        function renderView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function renderPosts(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = posts.length > 0 ? '' : '<p class="text-center text-gray-500">The feed is quiet... for now.</p>';
            posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white p-6 rounded-2xl shadow-lg border-t-4 border-gray-200';
                postElement.innerHTML = `
                    <div class="flex items-center space-x-4 mb-2">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl ${post.type === 'author' ? 'bg-purple-200 text-purple-700' : 'bg-sky-200 text-sky-700'}">${post.name.charAt(0)}</div>
                        <div>
                            <p class="font-semibold text-gray-800 text-lg">${post.name}</p>
                            <p class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 mt-4 leading-relaxed">${post.content}</p>
                `;
                container.appendChild(postElement);
            });
        }
        
        function renderAuthors(authors) {
             const container = document.getElementById('authors-container');
             container.innerHTML = '';
             authors.forEach(author => {
                 const card = document.createElement('div');
                 card.className = 'bg-white p-8 rounded-2xl shadow-lg border-t-4 border-purple-600';
                 const booksHtml = author.books ? author.books.map(book => `<div class="p-2 bg-gray-100 rounded-lg text-xs font-semibold text-gray-600">${book.title}</div>`).join('') : '';
                 card.innerHTML = `
                     <div class="flex items-center space-x-4 mb-4">
                         <div class="w-16 h-16 bg-purple-200 rounded-full flex items-center justify-center font-bold text-purple-700 text-2xl">${author.name.charAt(0)}</div>
                         <h3 class="font-bold text-2xl text-gray-800">${author.name}</h3>
                     </div>
                     <p class="text-gray-600 text-sm leading-snug">${author.bio}</p>
                     <div class="mt-6 flex flex-wrap gap-2">${booksHtml}</div>
                 `;
                 container.appendChild(card);
             });
        }

        function renderInfluencers(influencers) {
             const container = document.getElementById('influencers-container');
             container.innerHTML = '';
             influencers.forEach(influencer => {
                 const card = document.createElement('div');
                 card.className = 'bg-white p-8 rounded-2xl shadow-lg border-t-4 border-sky-500';
                 card.innerHTML = `
                     <div class="flex items-center space-x-4 mb-4">
                         <div class="w-16 h-16 bg-sky-200 rounded-full flex items-center justify-center font-bold text-sky-700 text-2xl">${influencer.name.charAt(0)}</div>
                         <h3 class="font-bold text-2xl text-gray-800">${influencer.name}</h3>
                     </div>
                     <p class="text-gray-600 text-sm">Platform: <span class="font-semibold text-gray-800">${influencer.platform}</span></p>
                     <p class="text-gray-600 text-sm mt-1">Interests: <span class="font-semibold text-gray-800">${influencer.interests}</span></p>
                 `;
                 container.appendChild(card);
             });
        }

        function renderMatches(matches) {
             const container = document.getElementById('matches-container');
             container.innerHTML = '';
             matches.forEach(match => {
                 const card = document.createElement('div');
                 card.className = 'bg-white p-6 rounded-2xl shadow-md border border-gray-200';
                 card.innerHTML = `
                     <h3 class="font-bold text-lg text-gray-800">${match.name}</h3>
                     <p class="text-gray-600 text-sm mt-1">${match.type === 'author' ? 'Author' : 'Influencer'}</p>
                     <p class="text-gray-500 text-xs mt-2 truncate">${match.bio || match.interests}</p>
                     <button class="connect-btn mt-4 px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition duration-300" data-user-id="${match.id}">Connect</button>
                 `;
                 container.appendChild(card);
             });
        }
        
        // --- Start the App ---
        initializeAppAndAuth();

    </script>
