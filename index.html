<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Author & Influencer Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="bg-white shadow-md py-4 sticky top-0 z-50">
        <nav class="container flex justify-between items-center px-4 md:px-6 lg:px-8">
            <div class="text-2xl font-bold text-gray-800">
                <span class="text-pink-500">Book</span>Connect
            </div>
            <div class="flex items-center space-x-4">
                <button id="nav-feed" class="text-gray-600 hover:text-pink-500 font-medium">Feed</button>
                <button id="nav-authors" class="text-gray-600 hover:text-pink-500 font-medium">Authors</button>
                <button id="nav-influencers" class="text-gray-600 hover:text-pink-500 font-medium">Influencers</button>
                <button id="nav-profile" class="text-gray-600 hover:text-pink-500 font-medium">Profile</button>
                <button id="nav-matches" class="text-gray-600 hover:text-pink-500 font-medium">Matches</button>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mt-8 px-4 md:px-6 lg:px-8">
        <!-- Loading state -->
        <div id="loading" class="text-center py-10">
            <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full border-pink-500 border-r-transparent" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="text-gray-600 mt-2">Connecting to the library...</p>
        </div>

        <!-- Main Content View -->
        <div id="content" class="space-y-8 hidden">
            <!-- User Info Bar -->
            <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                <p class="text-sm text-gray-500">Logged in as: <span id="user-id" class="font-mono text-xs text-pink-500"></span></p>
                <p class="text-sm text-gray-500">User Type: <span id="user-type" class="font-semibold text-gray-700">Not Set</span></p>
            </div>

            <!-- Feed View -->
            <section id="feed-view" class="view">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Social Feed</h2>
                <div id="posts-container" class="space-y-6">
                    <!-- Posts will be rendered here -->
                </div>
            </section>

            <!-- Profile View -->
            <section id="profile-view" class="view hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">My Profile</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <p class="text-lg font-semibold mb-4">Choose your account type:</p>
                    <div class="flex space-x-4 mb-6">
                        <button id="author-btn" class="px-6 py-2 rounded-lg font-semibold transition duration-300 bg-pink-500 text-white hover:bg-pink-600">I'm an Author</button>
                        <button id="influencer-btn" class="px-6 py-2 rounded-lg font-semibold transition duration-300 bg-blue-500 text-white hover:bg-blue-600">I'm an Influencer</button>
                    </div>

                    <!-- Author Profile Form -->
                    <div id="author-form-container" class="hidden">
                        <h3 class="text-xl font-bold mb-4 text-pink-500">Author Profile Setup</h3>
                        <form id="author-form" class="space-y-4">
                            <div>
                                <label for="author-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                                <input type="text" id="author-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2" placeholder="Jane Doe">
                            </div>
                            <div>
                                <label for="author-bio" class="block text-sm font-medium text-gray-700">Bio</label>
                                <textarea id="author-bio" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2" placeholder="I'm a romance author specializing in fantasy novels."></textarea>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-pink-500 text-white rounded-lg shadow-md hover:bg-pink-600 transition duration-300">Save Profile</button>
                        </form>
                    </div>

                    <!-- Influencer Profile Form -->
                    <div id="influencer-form-container" class="hidden">
                        <h3 class="text-xl font-bold mb-4 text-blue-500">Influencer Profile Setup</h3>
                        <form id="influencer-form" class="space-y-4">
                            <div>
                                <label for="influencer-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                                <input type="text" id="influencer-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="John Doe">
                            </div>
                            <div>
                                <label for="influencer-platform" class="block text-sm font-medium text-gray-700">Main Platform (e.g., TikTok, Instagram, Blog)</label>
                                <input type="text" id="influencer-platform" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="TikTok">
                            </div>
                            <div>
                                <label for="influencer-interests" class="block text-sm font-medium text-gray-700">Niche Interests (e.g., historical romance, dark academia)</label>
                                <input type="text" id="influencer-interests" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Historical Romance">
                            </div>
                            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition duration-300">Save Profile</button>
                        </form>
                    </div>

                    <!-- Book Ingression Form (for authors) -->
                    <div id="book-form-container" class="hidden mt-8">
                        <h3 class="text-xl font-bold mb-4 text-pink-500">Ingress a New Book</h3>
                        <form id="book-form" class="space-y-4">
                            <div>
                                <label for="book-title" class="block text-sm font-medium text-gray-700">Book Title</label>
                                <input type="text" id="book-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="book-blurb" class="block text-sm font-medium text-gray-700">Blurb</label>
                                <textarea id="book-blurb" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                            </div>
                            <div>
                                <label for="book-cover" class="block text-sm font-medium text-gray-700">Cover Image URL</label>
                                <input type="text" id="book-cover" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <button type="submit" class="px-4 py-2 bg-pink-500 text-white rounded-lg shadow-md hover:bg-pink-600 transition duration-300">Submit Book</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Authors View -->
            <section id="authors-view" class="view hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Authors</h2>
                <div id="authors-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Author cards will be rendered here -->
                </div>
            </section>

            <!-- Influencers View -->
            <section id="influencers-view" class="view hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Influencers</h2>
                <div id="influencers-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Influencer cards will be rendered here -->
                </div>
            </section>

            <!-- Matches View -->
            <section id="matches-view" class="view hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Matches</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <p class="text-gray-600 text-center">
                        This is where we'd use our matchmaking algorithm! For the MVP, here's a random selection of potential matches.
                    </p>
                    <div id="matches-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                        <!-- Match cards will be rendered here -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container text-center text-sm">
            &copy; 2024 BookConnect. All rights reserved.
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        let db, auth, userId;
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                document.getElementById('user-id').textContent = userId;
                console.log("Signed in with user ID:", userId);
                initApp();
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        // --- Data Models and Dummy Data ---
        const dummyPosts = [
            { id: uuid.v4(), author: "Samantha", content: "Just finished my latest manuscript! It's a dark romance with a touch of fantasy. I'm so excited to find the perfect influencers to review it.", type: "author", timestamp: Date.now() - 3600000 },
            { id: uuid.v4(), author: "Bookworm Emily", content: "Looking for new authors to collaborate with! My channel focuses on spicy historical romance. Drop your books below!", type: "influencer", timestamp: Date.now() - 7200000 },
            { id: uuid.v4(), author: "Liam Jones", content: "Thinking about a new campaign for my book 'Crimson Vows'. Maybe a giveaway for a signed copy and a cozy bookmark.", type: "author", timestamp: Date.now() - 10800000 },
            { id: uuid.v4(), author: "Reading Sarah", content: "My latest TikTok review of 'Midnight Whispers' is live! The author's world-building is incredible.", type: "influencer", timestamp: Date.now() - 14400000 },
            { id: uuid.v4(), author: "Chloe's Novels", content: "My new book cover reveal is coming soon! Any influencers interested in a sneak peek?", type: "author", timestamp: Date.now() - 18000000 },
        ];

        const dummyAuthors = [
            { id: 'dummy-author-1', name: 'Samantha', bio: 'Romance author specializing in fantasy and paranormal. Known for strong female leads and intricate world-building.' },
            { id: 'dummy-author-2', name: 'Liam Jones', bio: 'New York Times bestselling author of contemporary romance novels with a hint of suspense. I love writing about second chances.' },
            { id: 'dummy-author-3', name: 'Chloe\'s Novels', bio: 'I write steamy, feel-good romance novels set in small towns. Currently working on a new series!' }
        ];

        const dummyInfluencers = [
            { id: 'dummy-influencer-1', name: 'Bookworm Emily', platform: 'TikTok, Instagram', interests: 'Historical Romance, Spicy Romcoms' },
            { id: 'dummy-influencer-2', name: 'Reading Sarah', platform: 'Blog, YouTube', interests: 'Dark Academia, Fantasy Romance' },
            { id: 'dummy-influencer-3', name: 'The Book Nook', platform: 'YouTube', interests: 'Contemporary Romance, Paranormal Romance' }
        ];

        let userType = null;

        // --- UI Rendering Functions ---
        function renderView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function renderPosts(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';
            posts.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white p-6 rounded-xl shadow-sm';
                postElement.innerHTML = `
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-600">${post.author.charAt(0)}</div>
                        <div>
                            <p class="font-semibold text-gray-800">${post.author}</p>
                            <p class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 mt-2">${post.content}</p>
                `;
                container.appendChild(postElement);
            });
        }

        function renderAuthors(authors) {
            const container = document.getElementById('authors-container');
            container.innerHTML = '';
            authors.forEach(author => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md';
                card.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-12 h-12 bg-pink-200 rounded-full flex items-center justify-center font-bold text-pink-700 text-lg">${author.name.charAt(0)}</div>
                        <h3 class="font-bold text-xl text-gray-800">${author.name}</h3>
                    </div>
                    <p class="text-gray-600 text-sm">${author.bio}</p>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <!-- Books will go here -->
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderInfluencers(influencers) {
            const container = document.getElementById('influencers-container');
            container.innerHTML = '';
            influencers.forEach(influencer => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md';
                card.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center font-bold text-blue-700 text-lg">${influencer.name.charAt(0)}</div>
                        <h3 class="font-bold text-xl text-gray-800">${influencer.name}</h3>
                    </div>
                    <p class="text-gray-600 text-sm">Platform: <span class="font-semibold">${influencer.platform}</span></p>
                    <p class="text-gray-600 text-sm mt-1">Interests: <span class="font-semibold">${influencer.interests}</span></p>
                `;
                container.appendChild(card);
            });
        }

        function renderMatches(matches) {
            const container = document.getElementById('matches-container');
            container.innerHTML = '';
            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200';
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${match.name}</h3>
                    <p class="text-gray-600 text-sm mt-1">${match.type === 'author' ? 'Author' : 'Influencer'}</p>
                    <p class="text-gray-500 text-xs mt-2 truncate">${match.bio || match.interests}</p>
                    <button class="mt-4 px-3 py-1 text-xs font-semibold rounded-full bg-pink-100 text-pink-600 hover:bg-pink-200 transition duration-300">Connect</button>
                `;
                container.appendChild(card);
            });
        }

        // --- Data Fetching and Event Listeners ---
        function initApp() {
            // Check for existing user profile
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
            getDoc(userDocRef).then(docSnap => {
                if (docSnap.exists()) {
                    userType = docSnap.data().type;
                    document.getElementById('user-type').textContent = userType.charAt(0).toUpperCase() + userType.slice(1);
                    if (userType === 'author') {
                        document.getElementById('book-form-container').classList.remove('hidden');
                    }
                }
            }).catch(e => console.error("Error fetching user profile:", e));

            // Set up real-time listeners
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), (snapshot) => {
                const posts = snapshot.docs.map(doc => doc.data());
                renderPosts(posts.concat(dummyPosts));
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snapshot) => {
                const users = snapshot.docs.map(doc => doc.data());
                const authors = users.filter(u => u.type === 'author').concat(dummyAuthors);
                const influencers = users.filter(u => u.type === 'influencer').concat(dummyInfluencers);
                renderAuthors(authors);
                renderInfluencers(influencers);
            });

            // Set up event listeners for navigation
            document.getElementById('nav-feed').addEventListener('click', () => renderView('feed-view'));
            document.getElementById('nav-profile').addEventListener('click', () => renderView('profile-view'));
            document.getElementById('nav-authors').addEventListener('click', () => renderView('authors-view'));
            document.getElementById('nav-influencers').addEventListener('click', () => renderView('influencers-view'));
            document.getElementById('nav-matches').addEventListener('click', () => {
                const allUsers = [...dummyAuthors, ...dummyInfluencers];
                const matches = allUsers.sort(() => 0.5 - Math.random()).slice(0, 6);
                renderMatches(matches);
                renderView('matches-view');
            });
            
            // Initial view
            renderView('feed-view');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        // --- Forms and Data Submission ---
        document.getElementById('author-btn').addEventListener('click', () => {
            document.getElementById('author-form-container').classList.remove('hidden');
            document.getElementById('influencer-form-container').classList.add('hidden');
        });

        document.getElementById('influencer-btn').addEventListener('click', () => {
            document.getElementById('influencer-form-container').classList.remove('hidden');
            document.getElementById('author-form-container').classList.add('hidden');
        });

        document.getElementById('author-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('author-name').value;
            const bio = document.getElementById('author-bio').value;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), {
                    userId,
                    type: 'author',
                    name,
                    bio,
                });
                userType = 'author';
                document.getElementById('user-type').textContent = 'Author';
                document.getElementById('book-form-container').classList.remove('hidden');
                console.log("Author profile saved successfully!");
            } catch (e) {
                console.error("Error saving author profile: ", e);
            }
        });

        document.getElementById('influencer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('influencer-name').value;
            const platform = document.getElementById('influencer-platform').value;
            const interests = document.getElementById('influencer-interests').value;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), {
                    userId,
                    type: 'influencer',
                    name,
                    platform,
                    interests,
                });
                userType = 'influencer';
                document.getElementById('user-type').textContent = 'Influencer';
                console.log("Influencer profile saved successfully!");
            } catch (e) {
                console.error("Error saving influencer profile: ", e);
            }
        });

        document.getElementById('book-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('book-title').value;
            const blurb = document.getElementById('book-blurb').value;
            const cover = document.getElementById('book-cover').value;
            const userName = document.getElementById('author-name').value;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'books'), {
                    authorId: userId,
                    authorName: userName,
                    title,
                    blurb,
                    cover,
                });
                // Create a dummy post for the feed
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                    author: userName,
                    content: `My new book '${title}' is out now! Check it out!`,
                    type: "author",
                    timestamp: Date.now(),
                });
                e.target.reset();
                console.log("Book and post submitted successfully!");
            } catch (e) {
                console.error("Error submitting book: ", e);
            }
        });

        // Start the app by signing in
        signIn();
    </script>
</body>
</html>
