async function signInWithCloudRunToken(uid) {
    try {
        const response = await fetch("https://jwt-737284668725.us-east4.run.app/getCustomToken", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ uid })
        });

        console.log("Response status:", response.status);
        for (let [key, value] of response.headers.entries()) {
            console.log(`  ${key}: ${value}`);
        }

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Response JSON:", data);

        if (!data.token) {
            throw new Error("No token returned from backend");
        }

        // âœ… Try Firebase sign-in
        return await signInWithCustomToken(auth, data.token);

    } catch (err) {
        console.error("Custom token sign-in failed, falling back to anonymous:", err);
        return await signInAnonymously(auth);
    }
}

// ðŸ”‘ App startup
onAuthStateChanged(auth, async (user) => {
    try {
        if (!user) {
            // No Firebase session yet â†’ try backend token first
            await signInWithCloudRunToken("temp-uid-" + Math.random().toString(36).substring(2, 10));
        }
    } catch (err) {
        console.error("Startup auth error:", err);
        await signInAnonymously(auth); // hard fallback
    } finally {
        // âœ… Always hide loading screen, show main view
        loadingEl.classList.add("hidden");
        mainContentView.classList.remove("hidden");
        renderNavbar(auth.currentUser);
    }
});
