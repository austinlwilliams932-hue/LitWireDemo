<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Configuration and Initialization ---
const firebaseConfig = {
apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
authDomain: "litwire-97956.firebaseapp.com",
projectId: "litwire-97956",
storageBucket: "litwire-97956.appspot.com",
messagingSenderId: "263009111921",
appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
measurementId: "G-ZWVFHF5YQX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- DOM Elements & Global Variables ---
const bodyEl = document.body;
const loadingEl = document.getElementById('loading');
const debugOutput = document.getElementById('debug-output');
const errorOverlay = document.getElementById('error-overlay');
const resetBtn = document.getElementById('reset-campaign-btn');
const actionButtons = document.getElementById('action-buttons');
const signOutBtn = document.getElementById('sign-out-btn');
const authorDashboard = document.getElementById('author-dashboard');
const influencerDashboard = document.getElementById('influencer-dashboard');
const planContainer = document.getElementById('plan-container');

// --- Helper Functions ---
function show(el){ el.classList.remove('content-hidden'); }
function hide(el){ el.classList.add('content-hidden'); }

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    signOutBtn.addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'index.html';
    });

    resetBtn.onclick = async () => {
        if (!auth.currentUser) return;
        const userId = auth.currentUser.uid;
        const authorProfileRef = doc(db, `users/${userId}/profiles/author`);
        const mainProfileRef = doc(db, `users/${userId}`);

        if (!confirm("Are you sure you want to reset your campaign? This will remove all data.")) return;

        try {
            await deleteDoc(authorProfileRef);
            await setDoc(mainProfileRef, { onboardingComplete: false, userType: 'author' }, { merge: true });
            window.location.href = 'index.html';
        } catch (err) {
            console.error(err);
            debugOutput.textContent = err.message || JSON.stringify(err, null, 2);
            show(errorOverlay);
        }
    };
});

// --- Data Rendering Functions (Omitted for brevity, unchanged) ---
function renderPlan(planData, bookTitle) {
    document.getElementById('book-title-plan').textContent = bookTitle || 'Your Book';
    planContainer.innerHTML = '';
    
    if (!planData || planData.length === 0) {
        planContainer.innerHTML = `<p class="text-gray-500">No campaign plan available. Ensure your profile has a book title, budget, and target audience specified.</p>`;
        return;
    }
    
    planData.forEach((step, index) => {
        const stepEl = document.createElement('div');
        stepEl.className = 'content-card';
        stepEl.innerHTML = `
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Step ${index + 1}: ${step.name || 'Untitled Step'}</h3>
            <p class="text-gray-600">${step.description || 'No description available for this step.'}</p>
        `;
        planContainer.appendChild(stepEl);
    });
}

// --- Cloud Function Call (Updated with Console Logging) ---
async function fetchCampaignPlanFromCF(bookTitle, budget, startDate, targetAudience) {
    const payload = { bookTitle, budget, startDate, targetAudience };
    
    // Log Initialization
    console.log("CF Status: Initializing request to Cloud Function...", payload);

    try {
        const response = await fetch('https://marketingsteps-737284668725.us-east4.run.app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            
            // Log Failure (HTTP Error)
            console.error(`CF Status: Failed with HTTP ${response.status}.`, errorData);
            
            throw new Error(`Cloud Function error: ${response.status} - ${errorData}`);
        }
        
        const data = await response.json();
        
        // Log Success
        console.log("CF Status: Finished successfully. Plan steps received:", data.marketingPlan ? data.marketingPlan.length : 0);
        
        return data.marketingPlan || [];
    } catch (err) {
        // Log Failure (Network/Parsing Error)
        if (!err.message.includes("Cloud Function error")) {
            console.error("CF Status: Failed due to network or parsing error.", err);
        }

        debugOutput.textContent = `Error fetching campaign plan:\n${err.message || err}`;
        show(errorOverlay);
        return [];
    }
}

// --- Main Authentication & Dashboard Load Logic (Omitted for brevity, unchanged) ---
onAuthStateChanged(auth, async user => {
    if(!user){
        window.location.href = 'index.html';
        return;
    }

    try {
        const mainProfileRef = doc(db, 'users', user.uid);
        const mainProfileSnap = await getDoc(mainProfileRef);
        
        if (!mainProfileSnap.exists()) {
            window.location.href = 'index.html';
            return;
        }
        
        const userData = mainProfileSnap.data();
        const userType = userData.userType;

        if (userType === 'author') {
            show(authorDashboard);
            show(actionButtons);
            
            const authorDocRef = doc(db, `users/${user.uid}/profiles/author`);
            const authorSnap = await getDoc(authorDocRef);
            let authorData = authorSnap.exists() ? authorSnap.data() : {};

            if (!authorSnap.exists()) {
                await setDoc(authorDocRef, {});
            }

            const cfPlan = await fetchCampaignPlanFromCF(
                authorData.bookTitle,
                authorData.budget || '0',
                authorData.startDate,
                authorData.targetAudience || []
            );
            renderPlan(cfPlan, authorData.bookTitle);

        } else if (userType === 'influencer') {
            show(influencerDashboard);
            hide(actionButtons);
        }
    } catch(err){
        console.error("Dashboard load error:", err);
        debugOutput.textContent = err.message || JSON.stringify(err, null, 2);
        show(errorOverlay);
    } finally {
        bodyEl.classList.remove('loading-state');
        hide(loadingEl);
    }
});
</script>
