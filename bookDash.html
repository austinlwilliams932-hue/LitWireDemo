<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
    authDomain: "litwire-97956.firebaseapp.com",
    projectId: "litwire-97956",
    storageBucket: "litwire-97956.appspot.com",
    messagingSenderId: "263009111921",
    appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
    measurementId: "G-ZWVFHF5YQX"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.addEventListener('DOMContentLoaded', () => {
    // DOM elements
    const loadingEl = document.getElementById('loading');
    const planContainer = document.getElementById('plan-container');
    const influencerGrid = document.getElementById('influencer-grid');
    const debugOutput = document.getElementById('debug-output');
    const errorOverlay = document.getElementById('error-overlay');
    const resetBtn = document.getElementById('reset-campaign-btn');
    const actionButtons = document.getElementById('action-buttons');
    const signOutBtn = document.getElementById('sign-out-btn');
    const tabs = document.querySelectorAll('.dashboard-tabs button');
    const tabContents = document.querySelectorAll('.dashboard-tab-content');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    // Tab switching
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`tab-content-${tab.id.split('-')[1]}`).classList.add('active');
        });
    });

    // Sign-out
    signOutBtn.addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'index.html';
    });

    // Render book info
    function renderBookData(bookData){
        document.getElementById('book-cover').src = bookData.coverPhoto || 'https://placehold.co/96x128';
        document.getElementById('book-title').textContent = bookData.title || 'Untitled Book';
        document.getElementById('book-description').textContent = bookData.description || 'No description available.';
        document.getElementById('campaign-dates').textContent = `Campaign Dates: N/A`;
    }

    // Render influencers
    function renderInfluencers(influencerData){
        influencerGrid.innerHTML = '';
        influencerData?.forEach(inf => {
            const card = document.createElement('div');
            card.className = 'influencer-card';
            card.innerHTML = `
                <img src="${inf.photo || 'https://placehold.co/96'}" alt="${inf.name}">
                <p class="font-semibold text-gray-900">${inf.name}</p>
                <p class="text-gray-600 text-sm">${inf.platform || 'Unknown Platform'}</p>
                <span class="tag">${inf.tier || 'Unknown Tier'}</span>
            `;
            influencerGrid.appendChild(card);
        });
    }

    // Render campaign plan
    function renderPlan(planData) {
        planContainer.innerHTML = '';

        if (!planData || planData.length === 0) {
            planContainer.innerHTML = `<p class="text-gray-500">No campaign plan available.</p>`;
            return;
        }

        planData.forEach((step, index) => {
            const stepEl = document.createElement('div');
            stepEl.className = 'content-card';
            stepEl.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Step ${index + 1}: ${step.name || 'Untitled Step'}</h3>
                <p class="text-gray-600">${step.description || 'No description available for this step.'}</p>
            `;
            planContainer.appendChild(stepEl);
        });
    }

    // Fetch campaign plan from Cloud Function
    async function fetchCampaignPlanFromCF(bookTitle, budget, startDate, targetAudience) {
        const payload = { bookTitle, budget, startDate, targetAudience };
        try {
            console.log("Sending payload to Cloud Function:", payload);

            const response = await fetch('https://marketingsteps-737284668725.us-east4.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Cloud Function error: ${response.status}`);

            const data = await response.json();
            console.log("Cloud Function returned:", data);

            return data.marketingPlan || [];
        } catch (err) {
            console.error('Error fetching campaign plan:', err);
            debugOutput.textContent = `Error fetching campaign plan:\n${err.message || err}`;
            show(errorOverlay);
            return [];
        }
    }

    // Auth state
    onAuthStateChanged(auth, async user => {
        if(!user){ window.location.href='index.html'; return; }
        show(actionButtons);

        try {
            const authorDocRef = doc(db, `users/${user.uid}/profiles/author`);
            const authorSnap = await getDoc(authorDocRef);

            if(authorSnap.exists()){
                const data = authorSnap.data();

                renderBookData({
                    title: data.bookTitle,
                    description: data.bookDescription,
                    publishedYear: data.startDate,
                    coverPhoto: data.coverPhoto
                });

                const cfPlan = await fetchCampaignPlanFromCF(
                    data.bookTitle,
                    data.budget || '0',
                    data.startDate,
                    data.targetAudience || []
                );

                renderPlan(cfPlan);
                renderInfluencers(data.influencers || []);
            } else {
                renderBookData({});
                renderPlan([]);
                renderInfluencers([]);
            }
        } catch(err){
            console.error(err);
            debugOutput.textContent = err.message || JSON.stringify(err, null, 2);
            show(errorOverlay);
        } finally{
            hide(loadingEl);
        }
    });

    // Reset campaign
    resetBtn.onclick = async () => {
        if (!auth.currentUser) return;
        const userId = auth.currentUser.uid;
        const authorProfileRef = doc(db, `users/${userId}/profiles/author`);
        const mainProfileRef = doc(db, `artifacts/users/${userId}/profile`);

        if (!confirm("Are you sure you want to reset your campaign? This will remove all data.")) return;

        try {
            try { await deleteDoc(authorProfileRef); } catch(err) { if (err.code !== 'not-found') throw err; }
            try { await setDoc(mainProfileRef, { onboardingComplete: false }, { merge: true }); } catch(err) { if (err.code !== 'not-found') throw err; }

            renderPlan([]);
            renderInfluencers([]);

            window.location.href = 'index.html';
        } catch (err) {
            console.error(err);
            debugOutput.textContent = err.message || JSON.stringify(err, null, 2);
            show(errorOverlay);
        }
    };
});
</script>
