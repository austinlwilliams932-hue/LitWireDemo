<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LitWire - Campaign Plan</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Base Styles */
body { 
    font-family: 'Inter', sans-serif; 
    background-color: #f3f4f6; 
    margin: 0; 
}
.container { max-width: 900px; margin: 0 auto; }
.content-card { background-color: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
.button { background-color: #2e598b; color: #fff; padding: 0.5rem 1.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
.button:hover { background-color: #234368; }
.header-top { width:100%; background-color:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.05); position:fixed; top:0; z-index:50; }
.header-top nav { max-width: 1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:1rem; }
.header-top a { color:#4b5563; font-weight:500; text-decoration:none; transition:color 0.2s; }
.header-top a:hover { color:#2e598b; }
.main { margin-top:6rem; padding:2rem; }

/* Visibility Control */
.content-hidden { display: none !important; }
.spinner-border { border: 4px solid rgba(0,0,0,0.1); border-top-color: #1e40af; border-radius: 50%; width: 3rem; height: 3rem; animation: spin 1s linear infinite; margin: auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Loading Overlay */
.loading-overlay, #error-overlay { 
    position: fixed; top:0; left:0; width:100%; height:100%; 
    display: flex; /* Starts visible until JS hides it */
    flex-direction:column; justify-content:center; align-items:center; z-index:100; 
    color:#fff; text-align:center; padding:1rem; 
}
.loading-overlay { background-color: rgba(0,0,0,0.7); }
#error-overlay { background-color: rgba(255,0,0,0.85); font-family: monospace; overflow:auto; }

/* Ensure main content is hidden initially while loading is visible */
.main { opacity: 0; visibility: hidden; transition: opacity 0.5s; } 
</style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center">

<header class="header-top">
<nav>
<div class="text-3xl font-bold text-gray-800"><a href="index.html"><span class="text-blue-900">Lit</span><span class="text-gray-900">Wire</span></a></div>
<div class="flex gap-6">
<a href="index.html">Home</a>
<a href="profile.html">Profile</a>
<a href="feed.html">Feed</a>
<a href="messages.html">Messages</a>
<a href="matches.html">Matches</a>
<a href="bookDash.html">Dashboard</a>
<a href="#" id="sign-out-btn" class="text-red-600 font-medium hover:text-red-800">Sign Out</a>
</div>
</nav>
</header>

<main id="main-content" class="main container">

<div id="author-dashboard" class="content-hidden">
    <div class="content-card">
        <h1 id="plan-header" class="text-3xl font-bold text-gray-900 mb-2">Campaign Plan for <span id="book-title-plan">Your Book</span></h1>
        <p id="plan-subheader" class="text-lg text-gray-600 mb-6">Generated by LitWire AI based on your profile.</p>
        
        <div id="plan-container" class="w-full">
            <p class="text-gray-500">Loading plan details...</p>
        </div>
    </div>
</div>

<div id="influencer-dashboard" class="content-hidden">
    <div class="content-card">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Influencer Dashboard</h1>
        <p class="text-lg text-gray-600">This page is for authors only. Please sign in as an author.</p>
    </div>
</div>

</main>

<div id="loading-overlay" class="loading-overlay">
<div class="spinner-border" role="status"></div>
<p class="text-xl mt-4">Generating dashboard...</p>
</div>

<div id="error-overlay" class="loading-overlay content-hidden">
<h2 class="text-2xl font-bold mb-4">Error</h2>
<pre id="debug-output" class="whitespace-pre-wrap"></pre>
<button id="error-close-btn" class="button mt-4">Close</button>
</div>

<div id="action-buttons" class="content-hidden fixed bottom-8 right-8 flex gap-4">
<button id="reset-campaign-btn" class="button bg-red-600 hover:bg-red-800">Reset Campaign</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


// --- Wrap EVERYTHING in DOMContentLoaded for maximum safety and execution order ---
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Configuration and Initialization (MOVED INSIDE) ---
    const firebaseConfig = {
    apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
    authDomain: "litwire-97956.firebaseapp.com",
    projectId: "litwire-97956",
    storageBucket: "litwire-97956.appspot.com",
    messagingSenderId: "263009111921",
    appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
    measurementId: "G-ZWVFHF5YQX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM Elements & Global Variables ---
    const mainContent = document.getElementById('main-content');
    const loadingEl = document.getElementById('loading-overlay');
    const debugOutput = document.getElementById('debug-output');
    const errorOverlay = document.getElementById('error-overlay');
    const errorCloseBtn = document.getElementById('error-close-btn');
    const resetBtn = document.getElementById('reset-campaign-btn');
    const actionButtons = document.getElementById('action-buttons');
    const signOutBtn = document.getElementById('sign-out-btn');
    const authorDashboard = document.getElementById('author-dashboard');
    const influencerDashboard = document.getElementById('influencer-dashboard');
    const planContainer = document.getElementById('plan-container');

    // --- Helper Functions ---
    function show(el){ el.classList.remove('content-hidden'); }
    function hide(el){ el.classList.add('content-hidden'); }

    function showMainContent() {
        mainContent.style.opacity = '1';
        mainContent.style.visibility = 'visible';
    }

    // --- Event Listeners ---
    signOutBtn.addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'index.html';
    });

    errorCloseBtn.addEventListener('click', () => {
        hide(errorOverlay);
    });

    resetBtn.addEventListener('click', async () => {
        if (!auth.currentUser) return;
        const userId = auth.currentUser.uid;
        const authorProfileRef = doc(db, `users/${userId}/profiles/author`);
        const mainProfileRef = doc(db, `users/${userId}`);

        if (!confirm("Are you sure you want to reset your campaign? This will remove all data.")) return;

        try {
            await deleteDoc(authorProfileRef);
            await setDoc(mainProfileRef, { onboardingComplete: false, userType: 'author' }, { merge: true });
            window.location.href = 'index.html';
        } catch (err) {
            console.error(err);
            debugOutput.textContent = err.message || JSON.stringify(err, null, 2);
            show(errorOverlay);
        }
    });

    // --- Data Rendering Functions ---
    function renderPlan(planData, bookTitle) {
        document.getElementById('book-title-plan').textContent = bookTitle || 'Your Book';
        planContainer.innerHTML = '';
        
        if (!planData || planData.length === 0) {
            planContainer.innerHTML = `<p class="text-gray-500">No campaign plan available. Ensure your profile has a book title, budget, and target audience specified.</p>`;
            return;
        }
        
        planData.forEach((step, index) => {
            const stepEl = document.createElement('div');
            stepEl.className = 'content-card';
            stepEl.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Step ${index + 1}: ${step.name || 'Untitled Step'}</h3>
                <p class="text-gray-600">${step.description || 'No description available for this step.'}</p>
            `;
            planContainer.appendChild(stepEl);
        });
    }

    // --- Cloud Function Call (With Logging) ---
    async function fetchCampaignPlanFromCF(bookTitle, budget, startDate, targetAudience) {
        const payload = { bookTitle, budget, startDate, targetAudience };
        
        // LOG 1: Initialization
        console.log("CF Status: Initializing request to Cloud Function...", payload);

        try {
            const response = await fetch('https://marketingsteps-737284668725.us-east4.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorData = await response.text();
                // LOG 2: Failure (HTTP Error)
                console.error(`CF Status: Failed with HTTP ${response.status}.`, errorData);
                throw new Error(`Cloud Function error: ${response.status} - ${errorData}`);
            }
            
            const data = await response.json();
            // LOG 3: Success
            console.log("CF Status: Finished successfully. Plan steps received:", data.marketingPlan ? data.marketingPlan.length : 0);
            
            return data.marketingPlan || [];
        } catch (err) {
            if (!err.message.includes("Cloud Function error")) {
                // LOG 4: Failure (Network/Parsing Error)
                console.error("CF Status: Failed due to network or parsing error.", err);
            }

            debugOutput.textContent = `Error fetching campaign plan:\n${err.message || err}`;
            show(errorOverlay);
            return [];
        }
    }

    // --- Main Authentication & Dashboard Load Logic ---
    
    // Explicitly show loading spinner here before starting the async auth check
    show(loadingEl); 
    
    onAuthStateChanged(auth, async user => {
        if(!user){
            window.location.href = 'index.html';
            return;
        }

        try {
            const mainProfileRef = doc(db, 'users', user.uid);
            const mainProfileSnap = await getDoc(mainProfileRef);
            
            if (!mainProfileSnap.exists()) {
                window.location.href = 'index.html';
                return;
            }
            
            const userData = mainProfileSnap.data();
            const userType = userData.userType;

            if (userType === 'author') {
                show(authorDashboard);
                show(actionButtons);
                
                const authorDocRef = doc(db, `users/${user.uid}/profiles/author`);
                const authorSnap = await getDoc(authorDocRef);
                let authorData = authorSnap.exists() ? authorSnap.data() : {};

                if (!authorSnap.exists()) {
                    await setDoc(authorDocRef, {});
                }

                const cfPlan = await fetchCampaignPlanFromCF(
                    authorData.bookTitle,
                    authorData.budget || '0',
                    authorData.startDate,
                    authorData.targetAudience || []
                );
                renderPlan(cfPlan, authorData.bookTitle);

            } else if (userType === 'influencer') {
                show(influencerDashboard);
                hide(actionButtons);
            }
        } catch(err){
            console.error("Dashboard load error:", err);
            debugOutput.textContent = err.message || JSON.stringify(err, null, 2);
            show(errorOverlay);
        } finally {
            // Hide the loading spinner and reveal the main content gracefully
            hide(loadingEl);
            showMainContent();
        }
    });
});
</script>
</body>
</html>
