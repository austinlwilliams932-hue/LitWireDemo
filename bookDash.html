<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LitWire - Book Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener("DOMContentLoaded", () => {
      const loadingOverlay = document.getElementById("loading-overlay");
      const errorOverlay = document.getElementById("error-overlay");
      const debugOutput = document.getElementById("debug-output");

      const bookCoverEl = document.getElementById("book-cover");
      const bookTitleEl = document.getElementById("book-title");
      const campaignDatesEl = document.getElementById("campaign-dates");
      const statusBadgeEl = document.getElementById("status-badge");

      const metricMatches = document.getElementById("metric-matches");
      const metricReading = document.getElementById("metric-reading");
      const metricPosts = document.getElementById("metric-posts");

      const influencerGrid = document.getElementById("influencer-grid");
      const campaignPlanContent = document.getElementById("campaign-plan-content");

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        loadingOverlay.classList.remove("hidden");

        try {
          // Load Author Profile + Marketing Plan
          const profileRef = doc(db, `users/${user.uid}/profiles/author`);
          const profileSnap = await getDoc(profileRef);

          if (!profileSnap.exists()) throw "No author profile found";
          const profile = profileSnap.data();

          // Book Details
          bookCoverEl.src = profile.coverUrl || "https://via.placeholder.com/300x400?text=Book+Cover";
          bookTitleEl.textContent = profile.bookTitle || "Untitled Book";
          campaignDatesEl.textContent = profile.startDate && profile.endDate
            ? `Campaign: ${profile.startDate} â€“ ${profile.endDate}`
            : "Campaign dates not set";
          statusBadgeEl.textContent = profile.status || "Planned";

          // Metrics
          metricMatches.textContent = profile.marketingPlan?.length || 0;
          metricReading.textContent = profile.targetAudience?.length || 0;
          metricPosts.textContent = profile.promotionChannels?.length || 0;

          // Influencers Section
          influencerGrid.innerHTML = "";
          (profile.marketingPlan || []).forEach(item => {
            const card = document.createElement("div");
            card.className = "p-4 bg-white shadow rounded-xl flex flex-col";
            card.innerHTML = `
              <div class="font-semibold">${item["Opportunity Name"] || "Unknown"}</div>
              <div class="text-sm text-gray-500">${item["Platform "] || "Unknown"}</div>
              <div class="text-sm text-gray-400">Audience: ${item["Est. Audience Size"] || "N/A"}</div>
            `;
            influencerGrid.appendChild(card);
          });

          // Campaign Plan
          campaignPlanContent.textContent = profile.marketingPlan?.length
            ? "AI-generated campaign plan loaded successfully."
            : "Your campaign plan will appear here once generated.";

        } catch (err) {
          console.error(err);
          debugOutput.textContent = JSON.stringify(err, null, 2);
          errorOverlay.classList.remove("hidden");
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      });
    });
  </script>
</head>
<body class="bg-gray-50 font-[Inter]">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 hidden">
    <div class="animate-spin h-12 w-12 border-4 border-gray-300 border-t-blue-600 rounded-full"></div>
  </div>

  <!-- Error Overlay -->
  <div id="error-overlay" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50 hidden">
    <h2 class="text-xl font-semibold text-red-600 mb-4">Error Loading Data</h2>
    <pre id="debug-output" class="text-sm bg-gray-100 p-4 rounded-lg w-3/4 max-h-64 overflow-auto"></pre>
    <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg shadow">Retry</button>
  </div>

  <div class="max-w-5xl mx-auto p-6">
    <!-- Book Header -->
    <div class="flex gap-6 mb-6">
      <img id="book-cover" class="w-32 h-44 object-cover rounded-xl shadow" alt="Book Cover">
      <div class="flex flex-col justify-between">
        <h1 id="book-title" class="text-2xl font-bold">Loading...</h1>
        <p id="campaign-dates" class="text-gray-600 text-sm"></p>
        <span id="status-badge" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">Loading</span>
      </div>
    </div>

    <!-- Metrics -->
    <div class="grid grid-cols-3 gap-4 mb-8">
      <div class="bg-white shadow rounded-xl p-4 text-center">
        <p class="text-2xl font-bold" id="metric-matches">0</p>
        <p class="text-gray-500 text-sm">Opportunities</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 text-center">
        <p class="text-2xl font-bold" id="metric-reading">0</p>
        <p class="text-gray-500 text-sm">Audience Targets</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 text-center">
        <p class="text-2xl font-bold" id="metric-posts">0</p>
        <p class="text-gray-500 text-sm">Promo Channels</p>
      </div>
    </div>

    <!-- Influencers Section -->
    <h2 class="text-xl font-semibold mb-4">Matched Opportunities</h2>
    <div id="influencer-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10">
      <!-- Cards will be injected here -->
    </div>

    <!-- Campaign Plan -->
    <h2 class="text-xl font-semibold mb-4">Campaign Plan</h2>
    <div class="bg-white shadow rounded-xl p-4">
      <p id="campaign-plan-content" class="text-gray-600">Loading campaign plan...</p>
    </div>
  </div>
</body>
</html>
