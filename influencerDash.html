<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LitWire - Influencer Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; margin: 0; }
.dashboard-grid { display: grid; grid-template-columns: 240px 1fr 300px; grid-template-rows: 64px 1fr; height: 100vh; }
/* Mobile & Tablet adjustments */
@media (max-width: 1024px) {
    .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr auto; }
    .top-bar { grid-area: 1 / 1 / 2 / 2; }
    .left-sidebar { grid-area: 2 / 1 / 3 / 2; display: flex; overflow-x: auto; white-space: nowrap; }
    .left-sidebar nav a { padding: 1rem; border-bottom: 2px solid transparent; }
    .main-content { grid-area: 3 / 1 / 4 / 2; }
    .right-sidebar { grid-area: 4 / 1 / 5 / 2; }
}
.top-bar { grid-area: 1 / 1 / 2 / 4; background-color: #fff; padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; }
.left-sidebar { grid-area: 1 / 1 / 3 / 2; background-color: #1f2937; color: #d1d5db; padding: 2rem 0; display: flex; flex-direction: column; }
.left-sidebar nav a { display: flex; align-items: center; padding: 0.75rem 2rem; margin: 0.25rem 0; transition: background-color 0.2s, color 0.2s; border-radius: 0.5rem; }
.left-sidebar nav a:hover { background-color: #374151; color: #fff; }
.left-sidebar nav a.active { background-color: #2e598b; color: #fff; }
.main-content { grid-area: 2 / 2 / 3 / 3; overflow-y: auto; padding: 2rem; }
.right-sidebar { grid-area: 2 / 3 / 3 / 4; background-color: #fff; border-left: 1px solid #e5e7eb; padding: 2rem; overflow-y: auto; }
.card { background-color: #fff; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
.tag { display: inline-block; background-color: #e2e8f0; color: #475569; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
.button { background-color: #2e598b; color: #fff; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
.button:hover { background-color: #234368; }
.match-card { display: flex; gap: 1rem; background-color: #f9fafb; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; margin-bottom: 1rem; }
.match-card img { width: 80px; height: 120px; object-fit: cover; border-radius: 0.5rem; }
.match-card .match-reason { font-style: italic; color: #6b7280; font-size: 0.875rem; }
.status-tag { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
.status-new { background-color: #d1fae5; color: #065f46; }
.status-inprogress { background-color: #fef3c7; color: #92400e; }
.status-completed { background-color: #e0f2fe; color: #0c4a6e; }
.timeline-item { position: relative; padding: 1.5rem 0 0 2rem; border-left: 2px dashed #d1d5db; }
.timeline-item::before { content: ''; position: absolute; left: -8px; top: 1.5rem; width: 14px; height: 14px; background-color: #2e598b; border: 2px solid #fff; border-radius: 50%; }
.timeline-item:last-child { border-left: none; }
.timeline-item:last-child::before { display: none; }
.hidden { display: none; }
.loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99; }
.spinner-border { border: 4px solid rgba(0,0,0,0.1); border-top-color: #1e40af; border-radius: 50%; width: 3rem; height: 3rem; animation: spin 1s linear infinite; margin: auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-gray-100">
    <div id="loading-screen" class="loading-overlay">
        <div class="spinner-border" role="status"></div>
        <p class="text-xl mt-4 text-white">Loading your dashboard...</p>
    </div>

    <div id="main-dashboard" class="dashboard-grid hidden">
        <header class="top-bar">
            <div class="flex items-center space-x-4">
                <div class="text-2xl font-bold text-gray-800"><a href="index.html"><span class="text-blue-900">Lit</span><span class="text-gray-900">Wire</span></a></div>
                <div class="relative w-96">
                    <input type="text" placeholder="Search for books, authors, or campaigns" class="w-full px-4 py-2 rounded-full bg-gray-100 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <i class="fas fa-bell text-xl text-gray-600 hover:text-blue-900 cursor-pointer"></i>
                <div class="flex items-center space-x-2 cursor-pointer">
                    <img id="profile-photo" src="https://placehold.co/40x40" alt="Profile" class="w-10 h-10 rounded-full object-cover">
                    <span id="influencer-handle" class="font-medium text-gray-800">Loading...</span>
                    <i class="fas fa-caret-down text-sm text-gray-400"></i>
                </div>
            </div>
        </header>

        <aside class="left-sidebar">
            <nav class="flex-grow space-y-2">
                <a href="#" class="active"><i class="fas fa-tachometer-alt mr-3"></i><span>Dashboard</span></a>
                <a href="#"><i class="fas fa-user-circle mr-3"></i><span>My Profile</span></a>
                <a href="#"><i class="fas fa-star mr-3"></i><span>Matches</span></a>
                <a href="#"><i class="fas fa-rocket mr-3"></i><span>Campaigns</span></a>
                <a href="#"><i class="fas fa-envelope mr-3"></i><span>Messages</span></a>
                <a href="#"><i class="fas fa-chart-line mr-3"></i><span>Analytics</span></a>
            </nav>
            <div class="p-4 text-center">
                <button id="sign-out-btn" class="w-full button bg-red-600 hover:bg-red-800">Sign Out</button>
            </div>
        </aside>

        <main class="main-content">
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card text-center">
                    <p id="active-campaigns-count" class="text-4xl font-bold text-blue-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Active Campaigns</p>
                </div>
                <div class="card text-center">
                    <p id="pending-pitches-count" class="text-4xl font-bold text-blue-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Pending Pitches</p>
                </div>
                <div class="card text-center">
                    <p id="followers-reached-count" class="text-4xl font-bold text-blue-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Followers Reached</p>
                </div>
            </section>

            <section class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">My Matches</h2>
                    <a href="#" class="text-sm text-blue-800 hover:underline">View All</a>
                </div>
                <div id="matches-container" class="card space-y-4">
                    <p class="text-gray-500">Loading matches...</p>
                </div>
            </section>

            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Active Campaigns</h2>
                <div id="campaigns-container" class="card">
                    <p class="text-gray-500">Loading campaigns...</p>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Messages</h2>
                    <a href="#" class="text-sm text-blue-800 hover:underline">View Inbox</a>
                </div>
                <div id="messages-container" class="card space-y-4">
                    <p class="text-gray-500">Loading messages...</p>
                </div>
            </section>
        </main>

        <aside class="right-sidebar space-y-8">
            <div class="space-y-4">
                <h3 class="text-lg font-bold">Profile Highlights</h3>
                <div>
                    <p class="font-medium text-gray-700 mb-1">Genres</p>
                    <div id="genres-tags" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <p class="font-medium text-gray-700 mb-1">Aesthetic</p>
                    <div id="aesthetic-tag" class="flex items-center gap-2"></div>
                </div>
                <div>
                    <p class="font-medium text-gray-700 mb-1">Dealbreakers</p>
                    <div id="dealbreakers-tags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lg font-bold">Upcoming Deadlines</h3>
                <div id="deadlines-container" class="space-y-4">
                    <p class="text-gray-500">Loading deadlines...</p>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lg font-bold">Tips & Insights</h3>
                <div id="tips-container" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-gray-700">Loading tips...</p>
                </div>
            </div>
        </aside>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
    authDomain: "litwire-97956.firebaseapp.com",
    projectId: "litwire-97956",
    storageBucket: "litwire-97956.appspot.com",
    messagingSenderId: "263009111921",
    appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
    measurementId: "G-ZWVFHF5YQX"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.addEventListener('DOMContentLoaded', () => {
    // DOM elements
    const loadingScreen = document.getElementById('loading-screen');
    const mainDashboard = document.getElementById('main-dashboard');
    const signOutBtn = document.getElementById('sign-out-btn');
    const matchesContainer = document.getElementById('matches-container');
    const campaignsContainer = document.getElementById('campaigns-container');
    const messagesContainer = document.getElementById('messages-container');
    const genresTags = document.getElementById('genres-tags');
    const aestheticTag = document.getElementById('aesthetic-tag');
    const dealbreakersTags = document.getElementById('dealbreakers-tags');
    const deadlinesContainer = document.getElementById('deadlines-container');
    const tipsContainer = document.getElementById('tips-container');

    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    // Sign out functionality
    signOutBtn.addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'index.html';
    });

    // Helper functions to render dynamic content
    function renderMatches(matches) {
        matchesContainer.innerHTML = ''; // Clear existing content
        if (matches.length === 0) {
            matchesContainer.innerHTML = `<p class="text-gray-500">No new matches found at this time.</p>`;
            return;
        }
        matches.forEach(match => {
            const card = `
                <div class="match-card">
                    <img src="${match.bookCover || 'https://placehold.co/80x120'}" alt="Book Cover: ${match.bookTitle}">
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold">${match.bookTitle}</h3>
                        <p class="text-sm text-gray-500 mb-2">by ${match.authorName}</p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            ${match.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <p class="match-reason">✨ **Why this is a match:** ${match.matchReason}</p>
                    </div>
                    <div class="flex flex-col items-center justify-center space-y-2">
                        <button class="button">Accept</button>
                        <button class="text-sm text-gray-500 hover:text-gray-800 transition-colors">Pass</button>
                        <button class="text-sm text-gray-500 hover:text-gray-800 transition-colors">Save</button>
                    </div>
                </div>
            `;
            matchesContainer.innerHTML += card;
        });
    }

    function renderCampaigns(campaigns) {
        campaignsContainer.innerHTML = '';
        if (campaigns.length === 0) {
            campaignsContainer.innerHTML = `<p class="text-gray-500">No active campaigns.</p>`;
            return;
        }
        campaigns.forEach(campaign => {
            const statusClass = campaign.status === 'New' ? 'status-new' :
                                campaign.status === 'In Progress' ? 'status-inprogress' :
                                'status-completed';
            const statusText = campaign.status;
            const card = `
                <div class="timeline-item">
                    <h3 class="font-semibold text-lg">${campaign.title}</h3>
                    <p class="text-sm text-gray-600 mb-2">Campaign with ${campaign.authorName}</p>
                    <p class="text-sm text-gray-800">${campaign.status === 'Completed' ? 'Completed on' : 'Deadline'}: <span class="font-semibold">${campaign.date}</span></p>
                    <span class="status-tag ${statusClass}">${statusText}</span>
                </div>
            `;
            campaignsContainer.innerHTML += card;
        });
    }

    function renderMessages(messages) {
        messagesContainer.innerHTML = '';
        if (messages.length === 0) {
            messagesContainer.innerHTML = `<p class="text-gray-500">No new messages.</p>`;
            return;
        }
        messages.forEach(message => {
            const card = `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="font-semibold">${message.senderName}</p>
                    <p class="text-sm text-gray-600 truncate">${message.preview}</p>
                </div>
            `;
            messagesContainer.innerHTML += card;
        });
    }

    function renderProfileHighlights(profile) {
        // Profile Highlights
        genresTags.innerHTML = (profile.genres || []).map(genre => `<span class="tag">${genre}</span>`).join('') || '';
        
        aestheticTag.innerHTML = '';
        if (profile.aesthetic) {
            aestheticTag.innerHTML = `<i class="fas fa-moon text-gray-600"></i><span class="tag">${profile.aesthetic}</span>`;
        } else {
            aestheticTag.innerHTML = `<span class="text-sm text-gray-500">N/A</span>`;
        }
        
        dealbreakersTags.innerHTML = (profile.dealbreakerTags || []).map(db => `<span class="tag bg-red-100 text-red-700">${db}</span>`).join('') || '';
    }

    function renderDeadlines(deadlines) {
        deadlinesContainer.innerHTML = '';
        if (deadlines.length === 0) {
            deadlinesContainer.innerHTML = `<p class="text-gray-500">No upcoming deadlines.</p>`;
            return;
        }
        deadlines.forEach(deadline => {
            const card = `
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm font-medium text-yellow-800">${deadline.timeLeft}</p>
                    <p class="text-md text-gray-700">${deadline.task}</p>
                </div>
            `;
            deadlinesContainer.innerHTML += card;
        });
    }

    // Main data fetching logic
    onAuthStateChanged(auth, async user => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }

        const mainProfileRef = doc(db, 'users', user.uid);
        const influencerProfileRef = doc(db, `users/${user.uid}/profiles/influencer`);

        try {
            const mainProfileSnap = await getDoc(mainProfileRef);
            
            // CRITICAL FIX: Checking for 'userType' instead of 'accountType'
            if (!mainProfileSnap.exists() || mainProfileSnap.data().userType !== 'influencer') { 
                // If not an influencer, redirect to the author dashboard
                window.location.href = 'bookDash.html';
                return;
            }

            const influencerSnap = await getDoc(influencerProfileRef);
            if (influencerSnap.exists()) {
                const data = influencerSnap.data();

                // Populate header and stats
                document.getElementById('influencer-handle').textContent = data.handle || 'Your Handle';
                document.getElementById('profile-photo').src = data.profilePhoto || 'https://placehold.co/40x40';
                document.getElementById('active-campaigns-count').textContent = data.activeCampaigns || 0;
                document.getElementById('pending-pitches-count').textContent = data.pendingPitches || 0;
                document.getElementById('followers-reached-count').textContent = data.followersReached || 0;
                
                // Render main content sections
                renderMatches(data.matches || []);
                renderCampaigns(data.campaigns || []);
                renderMessages(data.messages || []);

                // Render sidebar widgets
                renderProfileHighlights(data); // Pass the full data object
                renderDeadlines(data.upcomingDeadlines || []);
                tipsContainer.innerHTML = `<p class="text-sm text-gray-700">${data.tips || 'No new tips at this time.'}</p>`;
            } else {
                // If main profile says 'influencer' but profile document is missing,
                // redirect them to the generic profile setup page to finish onboarding.
                console.log("Influencer profile missing. Redirecting to profile setup.");
                window.location.href = 'profile.html';
                return;
            }

        } catch (err) {
            console.error("Error fetching influencer data:", err);
            // In a real app, you might show a user-friendly error message here
        } finally {
            hide(loadingScreen);
            show(mainDashboard);
        }
    });
});
</script>
</body>
</html>
