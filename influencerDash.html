<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LitWire - Influencer Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
    /* Custom styles to match the LitWire aesthetic */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; margin: 0; }
    .header-top { width: 100%; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: fixed; top: 0; z-index: 50; }
    .header-top nav { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 1rem; }
    .content-card { background-color: #fff; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
    .tag { display: inline-block; background-color: #e5e7eb; color: #4b5563; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .button { background-color: #2e598b; color: #fff; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .button:hover { background-color: #234368; }

    /* Dashboard Tab Styling */
    .dashboard-tabs button {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }
    .dashboard-tabs button.active {
        color: #2e598b;
        border-bottom-color: #2e598b;
    }
    .dashboard-tab-content {
        padding-top: 1.5rem;
        display: none;
    }
    .dashboard-tab-content.active {
        display: block;
    }

    /* Loading and Error Overlays */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99; }
    .spinner-border { border: 4px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; width: 3rem; height: 3rem; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #error-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(255,0,0,0.85); color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; text-align:center; padding:1rem; font-family:monospace; overflow:auto; }
    #error-overlay.hidden { display:none; }
</style>
</head>
<body>

    <div id="loading-screen" class="loading-overlay">
        <div class="spinner-border" role="status"></div>
        <p class="text-xl mt-4 text-white">Loading your dashboard...</p>
    </div>

    <div id="error-overlay" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Dashboard Error</h2>
        <pre id="debug-output" class="whitespace-pre-wrap text-sm"></pre>
        <button onclick="document.getElementById('error-overlay').classList.add('hidden');" class="button mt-4 bg-red-800 hover:bg-red-900">Close</button>
    </div>

    <header class="header-top">
        <nav>
            <div class="text-3xl font-bold text-gray-800"><a href="index.html"><span class="text-blue-900">Lit</span><span class="text-gray-900">Wire</span></a></div>
            <div class="flex items-center space-x-6">
                <a href="#" class="text-gray-600 font-medium hover:text-blue-900">Profile</a>
                <a href="#" class="text-gray-600 font-medium hover:text-blue-900">Feed</a>
                <button id="sign-out-btn" class="text-red-600 font-medium hover:text-red-800">Sign Out</button>
            </div>
        </nav>
    </header>

    <div id="main-dashboard" class="w-full max-w-7xl mx-auto pt-24 pb-8 px-4 sm:px-6 lg:px-8 hidden">

        <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Influencer Dashboard</h1>
        <p class="text-lg text-gray-600 mb-8">Welcome, <span id="influencer-handle" class="font-semibold">Loading...</span>. Here are your latest matches and campaign stats.</p>

        <div class="border-b border-gray-200 mb-4 dashboard-tabs">
            <button id="tab-overview" class="active">Overview</button>
            <button id="tab-campaigns">Campaigns & Pitches</button>
            <button id="tab-profile">My Profile</button>
        </div>

        <div id="tab-content-overview" class="dashboard-tab-content active">
            
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="content-card text-center">
                    <p id="active-campaigns-count" class="text-4xl font-bold text-blue-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Active Campaigns</p>
                </div>
                <div class="content-card text-center">
                    <p id="pending-pitches-count" class="text-4xl font-bold text-blue-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Pending Pitches</p>
                </div>
                <div class="content-card text-center">
                    <p id="followers-reached-count" class="text-4xl font-bold text-blue-900">0</p>
                    <p class="text-sm text-gray-500 mt-1">Followers Reached</p>
                </div>
            </section>

            <section class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">New Matches for You</h2>
                    <a href="#" class="text-sm text-blue-800 hover:underline">View All Matches</a>
                </div>
                <div id="matches-container" class="content-card space-y-4">
                    <p class="text-gray-500">Loading matches...</p>
                </div>
            </section>

            <section class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Upcoming Deadlines</h2>
                <div id="deadlines-container" class="content-card space-y-4">
                     <p class="text-gray-500">Loading deadlines...</p>
                </div>
            </section>
        </div>

        <div id="tab-content-campaigns" class="dashboard-tab-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Active & Completed Campaigns</h2>
            <div id="campaigns-container" class="content-card">
                <p class="text-gray-500">Loading campaign history...</p>
            </div>
        </div>

        <div id="tab-content-profile" class="dashboard-tab-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">My Profile Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="content-card space-y-4">
                    <h3 class="text-xl font-semibold text-gray-800">Reading Preferences</h3>
                    <div>
                        <p class="font-medium text-gray-700 mb-1">Genres</p>
                        <div id="genres-tags" class="flex flex-wrap gap-2">
                             <span class="text-sm text-gray-500">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700 mb-1">Aesthetic</p>
                        <div id="aesthetic-tag" class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700 mb-1">Dealbreakers</p>
                        <div id="dealbreakers-tags" class="flex flex-wrap gap-2">
                             <span class="text-sm text-gray-500">Loading...</span>
                        </div>
                    </div>
                    <button class="button mt-4">Edit Profile Preferences</button>
                </div>

                <div class="content-card space-y-4">
                    <h3 class="text-xl font-semibold text-gray-800">Messages & Tips</h3>
                    <div id="messages-container" class="space-y-4 border-b pb-4">
                        <p class="text-gray-500">Loading messages...</p>
                    </div>
                    <h4 class="font-medium text-gray-700">Tips & Insights</h4>
                    <div id="tips-container" class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-gray-700">Loading tips...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
            authDomain: "litwire-97956.firebaseapp.com",
            projectId: "litwire-97956",
            storageBucket: "litwire-97956.appspot.com",
            messagingSenderId: "263009111921",
            appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
            measurementId: "G-ZWVFHF5YQX"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const loadingScreen = document.getElementById('loading-screen');
            const mainDashboard = document.getElementById('main-dashboard');
            const signOutBtn = document.getElementById('sign-out-btn');
            const matchesContainer = document.getElementById('matches-container');
            const campaignsContainer = document.getElementById('campaigns-container');
            const messagesContainer = document.getElementById('messages-container');
            const genresTags = document.getElementById('genres-tags');
            const aestheticTag = document.getElementById('aesthetic-tag');
            const dealbreakersTags = document.getElementById('dealbreakers-tags');
            const deadlinesContainer = document.getElementById('deadlines-container');
            const tipsContainer = document.getElementById('tips-container');
            const tabs = document.querySelectorAll('.dashboard-tabs button');
            const tabContents = document.querySelectorAll('.dashboard-tab-content');
        
            function show(el) { el.classList.remove('hidden'); }
            function hide(el) { el.classList.add('hidden'); }

            // Tab switching logic (copied from bookDash)
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-content-${tab.id.split('-')[1]}`).classList.add('active');
                });
            });
        
            // Sign out functionality
            signOutBtn.addEventListener('click', async () => {
                await signOut(auth);
                window.location.href = 'index.html';
            });
        
            // Helper functions to render dynamic content
            function renderMatches(matches) {
                matchesContainer.innerHTML = ''; // Clear existing content
                if (matches.length === 0) {
                    matchesContainer.innerHTML = `<p class="text-gray-500">No new matches found at this time.</p>`;
                    return;
                }
                // Using a simplified placeholder render for brevity
                matches.slice(0, 3).forEach(match => {
                    const card = `
                        <div class="flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0">
                            <div class="flex items-center space-x-3">
                                <img src="${match.bookCover || 'https://placehold.co/40x60'}" alt="Book Cover" class="w-10 h-15 object-cover rounded shadow">
                                <div>
                                    <h3 class="font-semibold text-gray-900">${match.bookTitle}</h3>
                                    <p class="text-sm text-gray-500">by ${match.authorName}</p>
                                </div>
                            </div>
                            <button class="button py-1 px-3 text-sm">Review Pitch</button>
                        </div>
                    `;
                    matchesContainer.innerHTML += card;
                });
            }
        
            function renderCampaigns(campaigns) {
                campaignsContainer.innerHTML = '';
                if (campaigns.length === 0) {
                    campaignsContainer.innerHTML = `<p class="text-gray-500">No active or completed campaigns.</p>`;
                    return;
                }
                campaigns.forEach(campaign => {
                    const statusClass = campaign.status === 'Active' ? 'bg-green-100 text-green-700' :
                                        campaign.status === 'Draft' ? 'bg-yellow-100 text-yellow-700' :
                                        'bg-blue-100 text-blue-700';
                    const card = `
                        <div class="p-4 border-b last:border-b-0 flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold text-lg">${campaign.title}</h3>
                                <p class="text-sm text-gray-500">Author: ${campaign.authorName}</p>
                            </div>
                            <span class="tag ${statusClass}">${campaign.status}</span>
                        </div>
                    `;
                    campaignsContainer.innerHTML += card;
                });
            }
        
            function renderMessages(messages) {
                messagesContainer.innerHTML = '';
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `<p class="text-gray-500">No new messages.</p>`;
                    return;
                }
                messages.forEach(message => {
                    const card = `
                        <div class="p-2 bg-gray-50 rounded-lg">
                            <p class="font-semibold text-sm">${message.senderName}</p>
                            <p class="text-xs text-gray-600 truncate">${message.preview}</p>
                        </div>
                    `;
                    messagesContainer.innerHTML += card;
                });
            }
        
            function renderProfileHighlights(profile) {
                // Profile Highlights
                genresTags.innerHTML = '';
                genresTags.innerHTML = (profile.genres || []).map(genre => `<span class="tag">${genre}</span>`).join('') || '';
                
                aestheticTag.innerHTML = '';
                if (profile.aesthetic) {
                    aestheticTag.innerHTML = `<i class="fas fa-palette text-gray-600 mr-2"></i><span class="tag">${profile.aesthetic}</span>`;
                } else {
                    aestheticTag.innerHTML = `<span class="text-sm text-gray-500">N/A</span>`;
                }
                
                dealbreakersTags.innerHTML = '';
                dealbreakersTags.innerHTML = (profile.dealbreakerTags || []).map(db => `<span class="tag bg-red-100 text-red-700">${db}</span>`).join('') || '';
            }
        
            function renderDeadlines(deadlines) {
                deadlinesContainer.innerHTML = '';
                if (deadlines.length === 0) {
                    deadlinesContainer.innerHTML = `<p class="text-gray-500">No upcoming deadlines.</p>`;
                    return;
                }
                deadlines.forEach(deadline => {
                    const card = `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm font-medium text-yellow-800">${deadline.timeLeft}</p>
                            <p class="text-md text-gray-700">${deadline.task}</p>
                        </div>
                    `;
                    deadlinesContainer.innerHTML += card;
                });
            }
        
            // Main data fetching logic
            onAuthStateChanged(auth, async user => {
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
        
                const mainProfileRef = doc(db, 'users', user.uid);
                const influencerProfileRef = doc(db, `users/${user.uid}/profiles/influencer`);
        
                try {
                    const mainProfileSnap = await getDoc(mainProfileRef);
                    
                    // Critical check: Ensure the user is an 'influencer'
                    if (!mainProfileSnap.exists() || mainProfileSnap.data().userType !== 'influencer') { 
                        window.location.href = 'bookDash.html';
                        return;
                    }
        
                    const influencerSnap = await getDoc(influencerProfileRef);
                    if (influencerSnap.exists()) {
                        const data = influencerSnap.data();
        
                        // Mock data structure for demonstration
                        const mockData = {
                            handle: data.handle || '@Bookstagrammer',
                            profilePhoto: data.profilePhoto,
                            activeCampaigns: data.activeCampaigns || 1,
                            pendingPitches: data.pendingPitches || 3,
                            followersReached: data.followersReached || '15k',
                            matches: data.matches || [{ bookTitle: "The Gilded Cage", authorName: "L. K. Smith", bookCover: 'https://placehold.co/40x60', tags: ['Fantasy', 'Fae'], matchReason: "Matches your Fantasy and Dark Aesthetic preference." }],
                            campaigns: data.campaigns || [{ title: "The Star Thief Launch", authorName: "J. A. Doe", status: "Active" }, { title: "Cozy Mystery Promo", authorName: "M. E. Jones", status: "Completed" }],
                            messages: data.messages || [{ senderName: "LitWire Support", preview: "Your recent payment has been processed." }],
                            genres: data.genres || ['Fantasy', 'Sci-Fi'],
                            aesthetic: data.aesthetic || 'Dark/Moody',
                            dealbreakerTags: data.dealbreakerTags || ['Erotica', 'Mafia'],
                            upcomingDeadlines: data.upcomingDeadlines || [{ timeLeft: "3 days left", task: "Post first review video for 'The Gilded Cage'" }],
                            tips: data.tips || "Authors love engagement! Be sure to respond to your DMs."
                        };

                        // Populate header and stats
                        document.getElementById('influencer-handle').textContent = mockData.handle;
                        // document.getElementById('profile-photo').src = mockData.profilePhoto || 'https://placehold.co/40x40'; 
                        // Note: Profile photo element removed in HTML rewrite for simplicity, but kept here for reference.
                        document.getElementById('active-campaigns-count').textContent = mockData.activeCampaigns;
                        document.getElementById('pending-pitches-count').textContent = mockData.pendingPitches;
                        document.getElementById('followers-reached-count').textContent = mockData.followersReached;
                        
                        // Render main content sections
                        renderMatches(mockData.matches);
                        renderCampaigns(mockData.campaigns);
                        renderMessages(mockData.messages);
        
                        // Render profile sections
                        renderProfileHighlights(mockData); 
                        renderDeadlines(mockData.upcomingDeadlines);
                        tipsContainer.innerHTML = `<p class="text-sm text-gray-700">${mockData.tips}</p>`;

                    } else {
                        // Influencer profile document is missing, redirect to setup
                        console.log("Influencer profile missing. Redirecting to profile setup.");
                        window.location.href = 'profile.html';
                        return;
                    }
        
                } catch (err) {
                    console.error("Error fetching influencer data:", err);
                    document.getElementById('debug-output').textContent = err.message || JSON.stringify(err, null, 2);
                    document.getElementById('error-overlay').classList.remove('hidden');
                } finally {
                    hide(loadingScreen);
                    show(mainDashboard);
                }
            });
        });
    </script>
</body>
</html>
