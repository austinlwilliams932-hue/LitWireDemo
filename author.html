<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LitWire - Author Survey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-card {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: #2e598b;
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 89, 139, 0.2);
        }

        .is-error {
            border-color: #ef4444;
        }

        .btn-continue {
            background-color: #2e598b;
            color: #fff;
            padding: 0.75rem 2.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-continue:hover {
            background-color: #234368;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            color: #fff;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">
    <header class="w-full bg-white shadow-md py-4 absolute top-0">
        <nav class="container flex justify-between items-center px-4 md:px-8">
            <div class="text-3xl font-bold text-gray-800">
                <span class="text-blue-900">Lit</span><span class="text-gray-900">Wire</span>
            </div>
            <a href="index.html" class="text-gray-600 hover:text-blue-900 font-medium transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </a>
        </nav>
    </header>

    <main class="flex-grow container mt-24 mb-12 px-4 md:px-8">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-gray-900 mb-2">Let's get your book out there</h1>
            <p class="text-lg text-gray-600">Please provide some details to match you with the right influencers.</p>
        </div>

        <div class="form-card">
            <form id="author-form" class="space-y-6" novalidate>
                <!-- Book Title -->
                <div>
                    <label for="book-title" class="block text-sm font-medium text-gray-700 mb-2">Book Title *</label>
                    <input type="text" id="book-title" name="bookTitle" placeholder="Enter the title" class="form-input">
                </div>

                <!-- Book Description -->
                <div>
                    <label for="book-description" class="block text-sm font-medium text-gray-700 mb-2">Book Description *</label>
                    <textarea id="book-description" name="bookDescription" rows="4" placeholder="Briefly describe your book..." class="form-textarea"></textarea>
                </div>

                <!-- Subgenre -->
                <div>
                    <label for="subgenre" class="block text-sm font-medium text-gray-700 mb-2">Subgenre *</label>
                    <select id="subgenre" name="subgenre" class="form-select">
                        <option value="">Select subgenre</option>
                        <option value="fantasy">Fantasy</option>
                        <option value="sci-fi">Science Fiction</option>
                        <option value="thriller">Thriller</option>
                        <option value="romance">Romance</option>
                        <option value="mystery">Mystery</option>
                    </select>
                </div>

                <!-- Target Audience -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="target-audience-field">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target Audience *</label>
                        <div class="space-y-2">
                            <div><input type="checkbox" name="targetAudience" value="Adults"> Adults</div>
                            <div><input type="checkbox" name="targetAudience" value="Young Adults"> Young Adults</div>
                            <div><input type="checkbox" name="targetAudience" value="Teens"> Teens</div>
                            <div><input type="checkbox" name="targetAudience" value="Children"> Children</div>
                        </div>
                    </div>

                    <!-- Promotion Channels -->
                    <div id="promotion-channels-field">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Promotion Channels *</label>
                        <div class="space-y-2">
                            <div><input type="checkbox" name="promotionChannels" value="Instagram"> Instagram</div>
                            <div><input type="checkbox" name="promotionChannels" value="BookTok"> BookTok</div>
                            <div><input type="checkbox" name="promotionChannels" value="Podcasts"> Podcasts</div>
                            <div><input type="checkbox" name="promotionChannels" value="Book Tours"> Book Tours</div>
                            <div><input type="checkbox" name="promotionChannels" value="Book Clubs"> Book Clubs</div>
                        </div>
                    </div>
                </div>

                <!-- Dates + Budget -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Dates *</label>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" id="start-date" name="startDate" class="form-input">
                            <input type="date" id="end-date" name="endDate" class="form-input">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Budget ($) *</label>
                        <input type="number" id="budget" name="budget" placeholder="Enter budget" class="form-input">
                    </div>
                </div>

                <!-- Slider -->
                <div>
                    <label for="promotion-comfort" class="block text-sm font-medium text-gray-700 mb-2">Promotion Comfort</label>
                    <input type="range" id="promotion-comfort" name="promotionComfort" min="1" max="5" value="3" class="w-full">
                </div>

                <div class="text-center">
                    <button type="submit" id="continue-btn" class="btn-continue">
                        Continue
                    </button>
                    <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
            </form>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner mb-4"></div>
        <div class="text-xl font-medium">Creating your personalized marketing plan...</div>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase setup
  const firebaseConfig = JSON.parse(window.__firebase_config);
  const app = initializeApp(firebaseConfig, window.__app_id);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const form = document.getElementById('author-form');
  const errorMessage = document.getElementById('error-message');
  const loadingOverlay = document.getElementById('loading-overlay');

  // üîÆ Call your Cloud Function (Gemini-powered)
  async function generateMarketingPlan(formData) {
    try {
      const response = await fetch("https://bookie-737284668725.us-central1.run.app", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });

      if (!response.ok) throw new Error("Failed to generate plan");
      const data = await response.json();

      // Expecting { marketingPlan: "..." }
      return data.marketingPlan || "AI did not return a plan.";
    } catch (err) {
      console.error("Error generating marketing plan:", err);
      return "‚ö†Ô∏è We could not generate your marketing plan at this time.";
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    let errors = [];

    const title = document.getElementById('book-title');
    const description = document.getElementById('book-description');
    const subgenre = document.getElementById('subgenre');
    const targetAudience = document.querySelectorAll('input[name="targetAudience"]:checked');
    const promotionChannels = document.querySelectorAll('input[name="promotionChannels"]:checked');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const budget = document.getElementById('budget');

    // Reset error styles
    [title, description, subgenre, startDate, endDate, budget].forEach(el => el.classList.remove('is-error'));
    document.getElementById('target-audience-field').classList.remove('is-error');
    document.getElementById('promotion-channels-field').classList.remove('is-error');

    // Validation
    if (!title.value.trim()) { errors.push("Book title is required"); title.classList.add('is-error'); }
    if (!description.value.trim()) { errors.push("Book description is required"); description.classList.add('is-error'); }
    if (!subgenre.value) { errors.push("Subgenre is required"); subgenre.classList.add('is-error'); }
    if (targetAudience.length === 0) { errors.push("Select at least one target audience"); document.getElementById('target-audience-field').classList.add('is-error'); }
    if (promotionChannels.length === 0) { errors.push("Select at least one promotion channel"); document.getElementById('promotion-channels-field').classList.add('is-error'); }
    if (!startDate.value) { errors.push("Start date is required"); startDate.classList.add('is-error'); }
    if (!endDate.value) { errors.push("End date is required"); endDate.classList.add('is-error'); }
    if (!budget.value || budget.value <= 0) { errors.push("Budget must be greater than 0"); budget.classList.add('is-error'); }

    if (errors.length > 0) {
      errorMessage.textContent = errors.join(". ");
      errorMessage.classList.remove('hidden');
      return;
    }

    errorMessage.classList.add('hidden');
    loadingOverlay.classList.remove('hidden');

    // Build the form data
    const formData = {
      bookTitle: title.value,
      bookDescription: description.value,
      subgenre: subgenre.value,
      targetAudience: Array.from(targetAudience).map(el => el.value),
      promotionChannels: Array.from(promotionChannels).map(el => el.value),
      startDate: startDate.value,
      endDate: endDate.value,
      budget: parseFloat(budget.value),
      promotionComfort: parseInt(document.getElementById('promotion-comfort').value),
    };

    try {
      // Step 1: Call Gemini backend to generate plan
      const marketingPlan = await generateMarketingPlan(formData);

      // Step 2: Sign in to Firebase
      if (window.__initial_auth_token) {
        await signInWithCustomToken(auth, window.__initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }

      const user = auth.currentUser;
      if (!user) throw new Error("No authenticated user");

      // Step 3: Save form data + plan into Firestore
      const docRef = doc(db, `users/${user.uid}/profiles/author`);
      await setDoc(docRef, { ...formData, marketingPlan }, { merge: true });

      // Step 4: Redirect
      window.location.href = 'marketingPlan.html';
    } catch (err) {
      console.error("Error saving marketing plan:", err);
      loadingOverlay.classList.add('hidden');
      errorMessage.textContent = "Failed to save your plan. Please try again.";
      errorMessage.classList.remove('hidden');
    }
  });
</script>
</body>
</html>
