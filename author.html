<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Author Form</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50">

  <div class="max-w-3xl mx-auto py-10">
    <h1 class="text-2xl font-bold mb-6">Author Marketing Plan</h1>

    <!-- ‚úÖ novalidate prevents browser default submission -->
    <form id="author-form" class="space-y-6" novalidate>

      <div>
        <label for="book-title" class="block font-medium">Book Title</label>
        <input type="text" id="book-title" name="bookTitle" class="input">
      </div>

      <div>
        <label for="book-description" class="block font-medium">Book Description</label>
        <textarea id="book-description" name="bookDescription" class="input"></textarea>
      </div>

      <div>
        <label for="subgenre" class="block font-medium">Subgenre</label>
        <input type="text" id="subgenre" name="subgenre" class="input">
      </div>

      <div>
        <label for="start-date" class="block font-medium">Start Date</label>
        <input type="date" id="start-date" name="startDate" class="input">
      </div>

      <div>
        <label for="end-date" class="block font-medium">End Date</label>
        <input type="date" id="end-date" name="endDate" class="input">
      </div>

      <div>
        <label for="budget" class="block font-medium">Budget ($)</label>
        <input type="number" id="budget" name="budget" class="input">
      </div>

      <div>
        <label for="promotion-comfort" class="block font-medium">Promotion Comfort (1‚Äì5)</label>
        <input type="range" id="promotion-comfort" name="promotionComfort" min="1" max="5" value="3">
      </div>

      <div>
        <!-- ‚úÖ Button starts disabled -->
        <button type="submit" id="continue-btn"
          class="btn-continue opacity-50 cursor-not-allowed"
          disabled>
          <span id="btn-text">Continue</span>
          <span id="btn-spinner" class="hidden">‚è≥</span>
        </button>
      </div>

      <p id="error-message" class="text-red-600 hidden"></p>
    </form>
  </div>

  <!-- ‚úÖ Script placed after form -->
  <script type="module">
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // üîß Globals injection safe parsing
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let firebaseConfig = {};
    try {
      firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    } catch (err) {
      console.error("Invalid Firebase config JSON:", err);
      firebaseConfig = {};
    }

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase init
    setLogLevel('debug');
    let app, auth, db;
    try {
      app = initializeApp(firebaseConfig, appId);
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (err) {
      console.error("Firebase init failed:", err);
    }

    // DOM
    const form = document.getElementById('author-form');
    const continueBtn = document.getElementById('continue-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const errorMessage = document.getElementById('error-message');
    let userId = null;

    // Auth
    if (auth) {
      if (initialAuthToken) {
        signInWithCustomToken(auth, initialAuthToken).catch(err => {
          console.error("Custom token sign-in failed:", err);
          signInAnonymously(auth).catch(anonErr => console.error("Anon sign-in failed:", anonErr));
        });
      } else {
        signInAnonymously(auth).catch(anonErr => console.error("Anon sign-in failed:", anonErr));
      }

      onAuthStateChanged(auth, (user) => {
        userId = user ? user.uid : crypto.randomUUID();
        continueBtn.disabled = false;
        continueBtn.classList.remove("opacity-50", "cursor-not-allowed");
      });
    }

    // ‚úÖ Attach handler directly
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // stop page reload always
      console.log("‚úÖ Form submit intercepted");

      if (!userId) {
        errorMessage.textContent = "Please wait, authenticating‚Ä¶";
        errorMessage.classList.remove('hidden');
        return;
      }

      // Collect form data
      const formData = new FormData(form);
      const data = {
        book_title: formData.get('bookTitle'),
        book_description: formData.get('bookDescription'),
        book_genre: formData.get('subgenre'),
        start_date: formData.get('startDate'),
        end_date: formData.get('endDate'),
        budget: parseFloat(formData.get('budget')),
        promotion_comfort: parseInt(formData.get('promotionComfort')),
        profile_type: 'author'
      };

      // Show loading
      continueBtn.disabled = true;
      btnText.classList.add('hidden');
      btnSpinner.classList.remove('hidden');
      errorMessage.classList.add('hidden');

      try {
        // Save to Firestore
        if (db) {
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profiles/author`);
          await setDoc(userDocRef, data);
          console.log("‚úÖ User data saved to Firestore.");
        }

        // Cloud Run call
        if (auth && auth.currentUser) {
          const idToken = await auth.currentUser.getIdToken();
          const response = await fetch("https://bookie-737284668725.us-central1.run.app", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify(data)
          });

          const text = await response.text();
          if (!response.ok) throw new Error(`Cloud Run failed: ${response.status} - ${text}`);
          const result = JSON.parse(text);

          if (result && result.marketingPlan && db) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profiles/author`);
            await setDoc(userDocRef, { marketingPlan: result.marketingPlan }, { merge: true });
            console.log("‚úÖ Marketing plan saved.");
            window.location.href = 'marketingPlan.html';
          }
        }

      } catch (err) {
        console.error("‚ùå Submission error:", err);
        errorMessage.textContent = `Error: ${err.message}`;
        errorMessage.classList.remove('hidden');
        continueBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnSpinner.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
