<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
    authDomain: "litwire-97956.firebaseapp.com",
    projectId: "litwire-97956",
    storageBucket: "litwire-97956.firebasestorage.app",
    messagingSenderId: "263009111921",
    appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
    measurementId: "G-ZWVFHF5YQX"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loadingEl = document.getElementById('loading');
const planContainer = document.getElementById('plan-container');
const errorEl = document.getElementById('error-message');

function show(el) { el.classList.remove('hidden'); }
function hide(el) { el.classList.add('hidden'); }

function renderPlan(planData) {
    planContainer.innerHTML = '';
    if (!planData.length) {
        planContainer.innerHTML = `<div class="content-card text-center text-gray-700">Nothing found in Firestore.</div>`;
    } else {
        planData.forEach(item => {
            const card = document.createElement('div');
            card.className = 'content-card';

            const influencerName = item.opportunity_details?.Name || 'Unknown';
            const reason = item.rationale || 'No rationale provided';
            const message = item.draft_message || 'No message';

            card.innerHTML = `
                <h2 class="text-xl font-semibold mb-2">${influencerName}</h2>
                <p class="mb-2"><strong>Why this influencer:</strong> ${reason}</p>
                <p class="mb-4"><strong>Draft message:</strong> ${message}</p>
                <button class="button" onclick='sendMessage("${encodeURIComponent(message)}")'>Send Message</button>
            `;
            planContainer.appendChild(card);
        });
    }
    hide(loadingEl);
    show(planContainer);
}

function sendMessage(message) {
    alert('Sending message: ' + decodeURIComponent(message));
    // Implement actual send logic via API or email service
}

async function init() {
    try {
        console.log('[DEBUG] Signing in anonymously...');
        await signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;
                console.log('[DEBUG] User signed in with UID:', userId);

                const docRef = doc(db, `users/${userId}/profiles/author`);
                console.log('[DEBUG] Fetching Firestore document:', docRef.path);

                const docSnap = await getDoc(docRef);
                console.log('[DEBUG] Document snapshot:', docSnap);

                if (docSnap.exists()) {
                    const docData = docSnap.data();
                    console.log('[DEBUG] Document data:', docData);

                    const planData = docData.marketingPlan || [];
                    console.log('[DEBUG] Marketing plan array:', planData);

                    renderPlan(planData);
                } else {
                    console.warn('[DEBUG] Firestore document does not exist for this user');
                    renderPlan([]); // Show "Nothing found in Firestore"
                }
            } else {
                console.warn('[DEBUG] No user is currently signed in');
                renderPlan([]); // Show "Nothing found in Firestore"
            }
        });
    } catch (err) {
        console.error('[DEBUG] Error during init:', err);
        hide(loadingEl);
        errorEl.textContent = err.message;
        show(errorEl);
    }
}

init();
</script>
