<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LitWire - Your Marketing Plan</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.container { max-width: 900px; margin: 0 auto; }
.content-card { background-color: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
.button { background-color: #2e598b; color: #fff; padding: 0.5rem 1.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
.button:hover { background-color: #234368; }
.spinner-border { border: 4px solid rgba(0,0,0,0.1); border-top-color: #1e40af; border-radius: 50%; width: 3rem; height: 3rem; animation: spin 1s linear infinite; margin: auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.hidden { display: none; }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
<header class="w-full bg-white shadow-md py-4">
<nav class="container flex justify-between items-center px-4 md:px-8">
<div class="text-3xl font-bold text-gray-800"><span class="text-blue-900">Lit</span><span class="text-gray-900">Wire</span></div>
<a href="loggedInLanding.html" class="text-gray-600 hover:text-blue-900 font-medium transition duration-300"><i class="fas fa-home mr-2"></i>Home</a>
</nav>
</header>
<main class="flex-grow container mt-24 mb-12 px-4 md:px-8">
<div class="text-center mb-8">
<h1 class="text-4xl font-bold text-gray-900 mb-2">Your Marketing Plan</h1>
<p class="text-lg text-gray-600">Powered by Gemini AI</p>
</div>
<div id="loading" class="text-center py-10">
<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
<p class="text-gray-600 mt-4">Fetching your personalized plan...</p>
</div>
<div id="plan-container" class="hidden"></div>
<div id="error-message" class="content-card text-center text-red-500 hidden"></div>
</main>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBxYO1_dzEP2eLAADSG1hsjKBcDjeFCpmk",
    authDomain: "litwire-97956.firebaseapp.com",
    projectId: "litwire-97956",
    storageBucket: "litwire-97956.firebasestorage.app",
    messagingSenderId: "263009111921",
    appId: "1:263009111921:web:713622b1cfa59ddb9130d0",
    measurementId: "G-ZWVFHF5YQX"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loadingEl = document.getElementById('loading');
const planContainer = document.getElementById('plan-container');
const errorEl = document.getElementById('error-message');

function show(el) { el.classList.remove('hidden'); }
function hide(el) { el.classList.add('hidden'); }

function renderPlan(planData) {
    planContainer.innerHTML = '';
    if (!planData.length) {
        planContainer.innerHTML = `<div class="content-card text-center text-gray-700">Nothing found in Firestore.</div>`;
    } else {
        planData.forEach(item => {
            const card = document.createElement('div');
            card.className = 'content-card';

            const influencerName = item.opportunity_details?.Name || 'Unknown';
            const reason = item.rationale || 'No rationale provided';
            const message = item.draft_message || 'No message';

            card.innerHTML = `
                <h2 class="text-xl font-semibold mb-2">${influencerName}</h2>
                <p class="mb-2"><strong>Why this influencer:</strong> ${reason}</p>
                <p class="mb-4"><strong>Draft message:</strong> ${message}</p>
                <button class="button" onclick='sendMessage("${encodeURIComponent(message)}")'>Send Message</button>
            `;
            planContainer.appendChild(card);
        });
    }
    hide(loadingEl);
    show(planContainer);
}

function sendMessage(message) {
    alert('Sending message: ' + decodeURIComponent(message));
    // Implement actual send logic via API or email service
}

async function init() {
    try {
        console.log('[DEBUG] Signing in anonymously...');
        await signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;
                console.log('[DEBUG] User signed in with UID:', userId);

                const docRef = doc(db, `users/${userId}/profiles/author`);
                console.log('[DEBUG] Fetching Firestore document:', docRef.path);

                const docSnap = await getDoc(docRef);
                console.log('[DEBUG] Document snapshot:', docSnap);

                if (docSnap.exists()) {
                    const docData = docSnap.data();
                    console.log('[DEBUG] Document data:', docData);

                    const planData = docData.marketingPlan || [];
                    console.log('[DEBUG] Marketing plan array:', planData);

                    renderPlan(planData);
                } else {
                    console.warn('[DEBUG] Firestore document does not exist for this user');
                    renderPlan([]); // Show "Nothing found in Firestore"
                }
            } else {
                console.warn('[DEBUG] No user is currently signed in');
                renderPlan([]); // Show "Nothing found in Firestore"
            }
        });
    } catch (err) {
        console.error('[DEBUG] Error during init:', err);
        hide(loadingEl);
        errorEl.textContent = err.message;
        show(errorEl);
    }
}

init();
</script>
</body>
</html>
